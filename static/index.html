<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Google Play â€“ Top 100 Apps</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* â”€â”€ Design Tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --bg-body:     #0c0e14;
      --bg-surface:  #13151f;
      --bg-card:     #181b27;
      --bg-hover:    #1e2233;
      --bg-elevated: #1f2235;
      --border:      #262a3a;
      --border-subtle: #1e2130;
      --accent:      #7c3aed;
      --accent-soft: #a78bfa;
      --accent-muted: rgba(124,58,237,.12);
      --text:        #e8eaed;
      --text-secondary: #9ca3af;
      --text-muted:  #6b7280;
      --green:       #34d399;
      --red:         #f87171;
      --yellow:      #fbbf24;
      --radius-sm:   8px;
      --radius-md:   12px;
      --radius-lg:   16px;
      --radius-pill: 999px;
      --shadow-sm:   0 1px 3px rgba(0,0,0,.25);
      --shadow-md:   0 4px 16px rgba(0,0,0,.35);
      --shadow-lg:   0 8px 32px rgba(0,0,0,.45);
      --transition:  .2s cubic-bezier(.4,0,.2,1);
    }

    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      background: var(--bg-body);
      color: var(--text);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    ::selection {
      background: rgba(124,58,237,.35);
      color: #fff;
    }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #3a3e52; }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      background: linear-gradient(135deg, #12142a 0%, #1e1640 50%, #1a1235 100%);
      padding: 32px 32px 20px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      position: relative;
    }
    header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
    }
    header h1 {
      font-size: 1.65rem;
      font-weight: 700;
      color: #fff;
      letter-spacing: -.3px;
    }
    header h1 span, header h1::first-letter { color: var(--accent-soft); }
    header p {
      margin-top: 6px;
      font-size: .85rem;
      color: var(--text-secondary);
      font-weight: 400;
    }

    /* â”€â”€ Tab Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 6px;
      flex-wrap: wrap;
      padding: 14px 24px;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border-subtle);
    }
    .tab-btn {
      padding: 7px 18px;
      border: 1px solid transparent;
      border-radius: var(--radius-pill);
      background: transparent;
      color: var(--text-secondary);
      font-family: var(--font);
      font-size: .8rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
      letter-spacing: .01em;
    }
    .tab-btn:hover {
      background: var(--accent-muted);
      color: var(--accent-soft);
    }
    .tab-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 2px 12px rgba(124,58,237,.35);
    }

    /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main { max-width: 1120px; margin: 0 auto; padding: 28px 24px; }

    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 18px;
      letter-spacing: -.2px;
    }

    /* â”€â”€ Loading / Error â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .loading, .error {
      text-align: center;
      padding: 60px 20px;
      font-size: 1rem;
      font-weight: 500;
    }
    .loading { color: var(--accent-soft); }
    .error   { color: var(--red); }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Card Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 10px;
    }

    .card {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      transition: all var(--transition);
    }
    .card:hover {
      border-color: var(--accent);
      background: var(--bg-hover);
      box-shadow: 0 4px 20px rgba(124,58,237,.1);
      transform: translateY(-1px);
    }

    .rank {
      font-size: 1rem;
      font-weight: 700;
      color: var(--accent);
      min-width: 32px;
      text-align: center;
    }
    .rank.top3 { color: #facc15; font-size: 1.15rem; }

    .icon {
      width: 48px; height: 48px;
      border-radius: var(--radius-sm);
      object-fit: cover;
      flex-shrink: 0;
      background: var(--border);
    }

    .info { flex: 1; min-width: 0; }
    .info .name {
      font-size: .88rem;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .info .dev {
      font-size: .75rem;
      color: var(--text-secondary);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .meta {
      text-align: right;
      flex-shrink: 0;
    }
    .meta .installs {
      font-size: .78rem;
      color: var(--accent-soft);
      font-weight: 600;
    }
    .meta .rating {
      font-size: .75rem;
      color: #facc15;
      margin-top: 4px;
    }
    .meta .genre {
      font-size: .68rem;
      color: var(--text-muted);
      margin-top: 2px;
    }

    a.card-link { text-decoration: none; color: inherit; }

    /* â”€â”€ Keyword Pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .keywords-section {
      margin-bottom: 32px;
    }
    .keywords-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .kw-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-pill);
      padding: 7px 16px;
      font-size: .82rem;
      color: var(--accent-soft);
      transition: all var(--transition);
    }
    .kw-pill:hover {
      border-color: var(--accent);
      background: var(--bg-hover);
      transform: translateY(-1px);
    }
    .kw-rank {
      font-weight: 700;
      color: var(--accent);
      font-size: .75rem;
    }
    .kw-name {
      font-weight: 500;
    }
    .kw-count {
      font-size: .7rem;
      color: var(--text-muted);
    }

    /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    footer {
      text-align: center;
      padding: 28px 24px;
      font-size: .72rem;
      color: var(--text-muted);
      border-top: 1px solid var(--border-subtle);
    }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 600px) {
      .grid { grid-template-columns: 1fr; }
      header h1 { font-size: 1.3rem; }
      .modal-body { padding: 20px; max-width: 100%; }
      .detail-screenshots { gap: 8px; }
      .detail-screenshots img { height: 160px; }
      .tabs { gap: 4px; padding: 10px 12px; }
      .tab-btn { padding: 6px 12px; font-size: .75rem; }
    }

    /* â”€â”€ Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0, 0, 0, .7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      justify-content: center;
      align-items: flex-start;
      padding: 40px 16px;
      overflow-y: auto;
    }
    .modal-overlay.open { display: flex; }

    .modal-body {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      max-width: 720px;
      width: 100%;
      padding: 28px 32px;
      position: relative;
      animation: slideUp .25s ease;
      box-shadow: var(--shadow-lg);
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .modal-close {
      position: absolute;
      top: 14px; right: 18px;
      background: none; border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      transition: color var(--transition);
    }
    .modal-close:hover { color: #fff; }

    /* â”€â”€ Proxy Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .proxy-status-btn {
      position: absolute;
      top: 16px;
      right: 20px;
      padding: 6px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: rgba(19, 21, 31, .6);
      backdrop-filter: blur(8px);
      color: var(--text-secondary);
      font-family: var(--font);
      font-size: .75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
    }
    .proxy-status-btn:hover {
      border-color: var(--accent);
      color: var(--accent-soft);
      background: rgba(124,58,237,.08);
    }
    header { position: relative; }
    .proxy-list {
      list-style: none;
      padding: 0;
      margin: 12px 0 0;
    }
    .proxy-list li {
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      font-size: .82rem;
      font-family: 'SF Mono', 'Fira Code', 'Courier New', monospace;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .proxy-list li.alive {
      background: rgba(6,95,70,.4);
      color: var(--green);
      border: 1px solid rgba(52,211,153,.15);
    }
    .proxy-list li.dead {
      background: rgba(127,29,29,.4);
      color: var(--red);
      border: 1px solid rgba(248,113,113,.15);
    }
    .proxy-list li.direct {
      background: rgba(30,41,59,.6);
      color: #94a3b8;
      border: 1px solid var(--border);
    }
    .proxy-stat {
      display: flex;
      gap: 12px;
      margin-top: 14px;
    }
    .proxy-stat-card {
      flex: 1;
      background: var(--bg-body);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
      text-align: center;
    }
    .proxy-stat-card .psc-value {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .proxy-stat-card .psc-label {
      font-size: .72rem;
      color: var(--text-secondary);
      margin-top: 4px;
      font-weight: 500;
    }

    .detail-header {
      display: flex;
      gap: 18px;
      align-items: center;
      margin-bottom: 22px;
    }
    .detail-header img {
      width: 68px; height: 68px;
      border-radius: var(--radius-md);
      object-fit: cover;
      background: var(--border);
    }
    .detail-header .detail-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #fff;
      letter-spacing: -.2px;
    }
    .detail-header .detail-dev {
      font-size: .82rem;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .detail-header .detail-genre-badge {
      display: inline-block;
      margin-top: 6px;
      padding: 3px 10px;
      border-radius: var(--radius-pill);
      background: var(--accent-muted);
      border: 1px solid rgba(124,58,237,.2);
      font-size: .7rem;
      font-weight: 500;
      color: var(--accent-soft);
    }

    .detail-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-bottom: 22px;
    }
    .stat-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 14px;
      text-align: center;
    }
    .stat-card .stat-value {
      font-size: 1.05rem;
      font-weight: 700;
      color: var(--accent-soft);
    }
    .stat-card .stat-label {
      font-size: .68rem;
      color: var(--text-muted);
      margin-top: 4px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: .04em;
    }

    .detail-description {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 16px;
      margin-bottom: 18px;
      max-height: 260px;
      overflow-y: auto;
      font-size: .84rem;
      line-height: 1.65;
      color: #d1d5db;
      white-space: pre-line;
    }

    .detail-screenshots {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 8px;
      margin-bottom: 18px;
    }
    .detail-screenshots img {
      height: 200px;
      border-radius: var(--radius-sm);
      object-fit: cover;
      flex-shrink: 0;
    }

    .detail-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .detail-footer a {
      display: inline-block;
      padding: 10px 24px;
      background: var(--accent);
      color: #fff;
      border-radius: var(--radius-pill);
      text-decoration: none;
      font-size: .85rem;
      font-weight: 600;
      transition: background .2s;
    }
    .detail-footer a:hover { background: #6d28d9; }
    .detail-footer .detail-meta-info {
      font-size: .72rem;
      color: var(--text-muted);
    }

    /* â”€â”€ Competition Analyzer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .niche-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 10px;
      margin-bottom: 24px;
    }
    .niche-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 18px;
      transition: all var(--transition);
      cursor: pointer;
      position: relative;
    }
    .niche-card:hover {
      border-color: var(--accent);
      background: var(--bg-hover);
      box-shadow: 0 4px 20px rgba(124,58,237,.1);
      transform: translateY(-1px);
    }
    .niche-card .niche-name {
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }
    .niche-card .score-bar {
      height: 6px;
      border-radius: 3px;
      background: var(--border);
      margin-bottom: 10px;
      overflow: hidden;
    }
    .niche-card .score-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width .5s;
    }
    .niche-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 5px;
    }
    .niche-metric {
      font-size: .73rem;
      color: var(--text-secondary);
    }
    .niche-metric strong {
      color: var(--accent-soft);
    }
    .opportunity-badge {
      display: inline-block;
      padding: 3px 12px;
      border-radius: var(--radius-pill);
      font-size: .75rem;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: .02em;
    }
    .opp-high   { background: rgba(6,95,70,.5); color: var(--green); border: 1px solid rgba(52,211,153,.2); }
    .opp-medium { background: rgba(113,63,18,.5); color: var(--yellow); border: 1px solid rgba(251,191,36,.2); }
    .opp-low    { background: rgba(127,29,29,.5); color: var(--red); border: 1px solid rgba(248,113,113,.2); }

    .niche-add-form {
      background: var(--bg-card);
      border: 1px dashed rgba(124,58,237,.4);
      border-radius: var(--radius-md);
      padding: 22px;
      margin-bottom: 22px;
    }
    .niche-add-form h3 {
      margin: 0 0 14px;
      font-size: .95rem;
      font-weight: 600;
      color: #fff;
    }
    .niche-add-form input,
    .niche-add-form textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-body);
      color: var(--text);
      font-family: var(--font);
      font-size: .85rem;
      margin-bottom: 10px;
      transition: border-color var(--transition);
    }
    .niche-add-form input:focus,
    .niche-add-form textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(124,58,237,.15);
    }
    .niche-add-form textarea {
      min-height: 60px;
      resize: vertical;
    }
    .niche-add-form .niche-form-actions {
      display: flex;
      gap: 10px;
    }
    .niche-add-form button {
      padding: 9px 22px;
      border-radius: var(--radius-sm);
      border: none;
      font-family: var(--font);
      font-size: .82rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
    }
    .niche-add-form .btn-save {
      background: var(--accent);
      color: #fff;
    }
    .niche-add-form .btn-save:hover {
      background: #6d28d9;
      box-shadow: 0 2px 12px rgba(124,58,237,.3);
    }
    .niche-card .btn-delete {
      background: none;
      border: 1px solid rgba(127,29,29,.6);
      color: var(--red);
      padding: 3px 10px;
      border-radius: var(--radius-sm);
      font-family: var(--font);
      font-size: .68rem;
      font-weight: 500;
      cursor: pointer;
      float: right;
      transition: all var(--transition);
    }
    .niche-card .btn-delete:hover {
      background: rgba(127,29,29,.5);
      color: #fff;
    }

    /* â”€â”€ Add Category Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .add-cat-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,.6);
      z-index: 2000;
      align-items: center; justify-content: center;
    }
    .add-cat-overlay.open { display: flex; }
    .add-cat-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 28px 30px;
      width: 440px;
      max-width: 92vw;
      box-shadow: 0 12px 40px rgba(0,0,0,.5);
    }
    .add-cat-box h3 {
      margin: 0 0 16px;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
    }
    .add-cat-box input,
    .add-cat-box textarea {
      width: 100%; box-sizing: border-box;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--bg-body);
      color: var(--text);
      font-family: var(--font);
      font-size: .85rem;
      margin-bottom: 10px;
      transition: border-color var(--transition);
    }
    .add-cat-box input:focus,
    .add-cat-box textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(124,58,237,.15);
    }
    .add-cat-box textarea {
      min-height: 70px;
      resize: vertical;
    }
    .add-cat-box .form-row {
      display: flex; gap: 10px; align-items: center; margin-bottom: 10px;
    }
    .add-cat-box .form-row input { margin-bottom: 0; }
    .add-cat-box .emoji-input { width: 60px; text-align: center; font-size: 1.3rem; }
    .add-cat-box .btn-row { display: flex; gap: 10px; margin-top: 6px; }
    .add-cat-box button {
      padding: 9px 22px;
      border-radius: var(--radius-sm);
      border: none;
      font-family: var(--font);
      font-size: .82rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
    }
    .add-cat-box .btn-save {
      background: var(--accent); color: #fff;
    }
    .add-cat-box .btn-save:hover {
      background: #6d28d9;
      box-shadow: 0 2px 12px rgba(124,58,237,.3);
    }
    .add-cat-box .btn-cancel {
      background: var(--bg-body); color: var(--text-secondary);
      border: 1px solid var(--border);
    }
    .add-cat-box .btn-cancel:hover {
      background: var(--border); color: #fff;
    }
    .tab-btn.custom-cat { position: relative; }
    .tab-btn.custom-cat .cat-del {
      display: none;
      position: absolute; top: -5px; right: -5px;
      background: rgba(127,29,29,.8); color: #fff;
      border: none; border-radius: 50%;
      width: 16px; height: 16px;
      font-size: .6rem; line-height: 16px;
      text-align: center; cursor: pointer;
      z-index: 10;
    }
    .tab-btn.custom-cat:hover .cat-del { display: block; }
    .tab-btn.add-cat-btn {
      border: 1px dashed var(--accent);
      color: var(--accent);
      background: transparent;
      font-size: .8rem;
    }
    .tab-btn.add-cat-btn:hover {
      background: rgba(124,58,237,.1);
    }

    /* â”€â”€ Insights Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .insights-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 22px 24px;
      margin-bottom: 22px;
    }
    .insights-panel h3 {
      font-size: .95rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 16px;
    }
    .insight-stats {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 10px;
      margin-bottom: 18px;
    }
    .insight-stat {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 14px 12px;
      text-align: center;
    }
    .insight-stat .is-value {
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--accent-soft);
    }
    .insight-stat .is-label {
      font-size: .68rem;
      color: var(--text-muted);
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: .03em;
    }
    .insight-detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 700px) {
      .insight-detail-grid { grid-template-columns: 1fr; }
    }
    .insight-detail-box {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 16px;
    }
    .insight-detail-box h4 {
      font-size: .82rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 10px;
    }
    .insight-bar-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: .78rem;
    }
    .insight-bar-label {
      min-width: 90px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .insight-bar-track {
      flex: 1;
      height: 8px;
      background: var(--bg-body);
      border-radius: 4px;
      overflow: hidden;
    }
    .insight-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width .4s ease;
    }
    .insight-bar-count {
      min-width: 28px;
      text-align: right;
      font-weight: 600;
      color: var(--text);
      font-size: .72rem;
    }

    /* â”€â”€ Filter Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .filter-bar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 16px;
      padding: 12px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
    }
    .filter-bar label {
      font-size: .75rem;
      color: var(--text-secondary);
      font-weight: 500;
    }
    .filter-bar select,
    .filter-bar input[type="text"] {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-body);
      color: var(--text);
      font-family: var(--font);
      font-size: .78rem;
    }
    .filter-bar select:focus,
    .filter-bar input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .filter-bar .filter-count {
      margin-left: auto;
      font-size: .75rem;
      color: var(--text-muted);
    }
    .filter-bar .filter-reset {
      background: none; border: none;
      color: var(--accent-soft);
      font-family: var(--font);
      font-size: .75rem;
      cursor: pointer;
      text-decoration: underline;
    }

    /* â”€â”€ Bookmark star on cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card .bookmark-star {
      position: absolute;
      top: 6px; right: 8px;
      background: none; border: none;
      font-size: 1rem;
      cursor: pointer;
      opacity: 0;
      transition: opacity .2s;
      z-index: 5;
    }
    .card { position: relative; }
    .card:hover .bookmark-star { opacity: 1; }
    .card .bookmark-star.active, .card .bookmark-star.bookmarked { opacity: 1; color: #facc15; }

    /* â”€â”€ Category Comparison â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cat-compare-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 22px;
    }
    @media (max-width: 700px) {
      .cat-compare-grid { grid-template-columns: 1fr; }
    }
    .cat-compare-col {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 18px;
    }
    .cat-compare-col h4 {
      font-size: .9rem; font-weight: 600; color: #fff;
      margin-bottom: 14px;
    }
    .cc-metric {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border-subtle);
      font-size: .82rem;
    }
    .cc-metric .cc-label { color: var(--text-secondary); }
    .cc-metric .cc-value { font-weight: 600; color: var(--text); }
    .cc-better { color: var(--green) !important; }
    .cc-worse  { color: var(--red) !important; }

    /* â”€â”€ Cluster view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .cluster-section { margin-bottom: 24px; }
    .cluster-group {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 10px;
    }
    .cluster-group h4 {
      font-size: .85rem; font-weight: 600; color: var(--accent-soft);
      margin-bottom: 10px;
    }
    .cluster-apps {
      display: flex; flex-wrap: wrap; gap: 8px;
    }
    .cluster-app {
      background: var(--bg-surface);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 6px 12px;
      font-size: .78rem;
      color: var(--text);
      display: flex; align-items: center; gap: 6px;
    }
    .cluster-app img {
      width: 20px; height: 20px; border-radius: 4px;
    }
    .cluster-label {
      font-size: .9rem; font-weight: 600; margin-bottom: 8px;
    }
    .cluster-icon {
      width: 20px; height: 20px; border-radius: 4px;
    }

    /* â”€â”€ Growth table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .growth-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .82rem;
    }
    .growth-table th {
      text-align: left;
      padding: 10px 12px;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 2px solid var(--border);
      font-size: .72rem;
      text-transform: uppercase;
      letter-spacing: .04em;
    }
    .growth-table td {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-subtle);
      color: var(--text);
    }
    .growth-up { color: var(--green); }
    .growth-new { color: var(--yellow); font-style: italic; }

    /* â”€â”€ Note form in modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .note-section {
      margin-top: 18px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .note-section h4 {
      font-size: .82rem; font-weight: 600; color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .note-section textarea {
      width: 100%; box-sizing: border-box;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-body);
      color: var(--text);
      font-family: var(--font);
      font-size: .82rem;
      min-height: 60px;
      resize: vertical;
    }
    .note-section textarea:focus {
      outline: none;
      border-color: var(--accent);
    }
    .note-section .note-actions {
      display: flex; gap: 8px; margin-top: 8px; align-items: center;
    }
    .note-section .note-save-btn {
      padding: 6px 16px;
      background: var(--accent); color: #fff;
      border: none; border-radius: var(--radius-sm);
      font-family: var(--font); font-size: .78rem; font-weight: 600;
      cursor: pointer;
    }
    .note-section .note-bookmark-btn {
      background: none; border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 6px 12px;
      color: var(--text-secondary);
      font-size: .85rem;
      cursor: pointer;
      transition: all .2s;
    }
    .note-section .note-bookmark-btn.active {
      border-color: #facc15;
      color: #facc15;
    }
    .niche-card .niche-score-area {
      min-height: 28px;
      margin-top: 10px;
    }

    /* â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toolbar {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 18px;
    }
    .toolbar-btn {
      padding: 7px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-family: var(--font);
      font-size: .75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
    }
    .toolbar-btn:hover {
      border-color: var(--accent);
      color: var(--accent-soft);
      background: var(--bg-hover);
    }

    /* â”€â”€ Snapshot diff â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .diff-section { margin-bottom: 22px; }
    .diff-section h3 {
      font-size: .95rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 8px;
    }
    .diff-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      margin-bottom: 6px;
      font-size: .82rem;
    }
    .diff-item .change-positive { color: var(--green); font-weight: 600; }
    .diff-item .change-negative { color: var(--red); font-weight: 600; }

    /* â”€â”€ IP Blocked Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .blocked-overlay {
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0,0,0,.75);
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s;
    }
    .blocked-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }
    .blocked-box {
      background: #1c1e30;
      border: 2px solid #f87171;
      border-radius: 16px;
      padding: 32px 28px;
      max-width: 440px;
      width: 90%;
      text-align: center;
    }
    .blocked-box .blocked-icon { font-size: 3rem; margin-bottom: 12px; }
    .blocked-box h2 {
      color: #f87171;
      font-size: 1.3rem;
      margin-bottom: 10px;
    }
    .blocked-box p {
      color: #d1d5db;
      font-size: .88rem;
      line-height: 1.5;
      margin-bottom: 18px;
    }
    .blocked-box .countdown {
      font-size: .82rem;
      color: #9ca3af;
      margin-bottom: 14px;
    }
    .blocked-box button {
      padding: 8px 22px;
      border-radius: 8px;
      border: none;
      background: #374151;
      color: #e0e0e0;
      cursor: pointer;
      font-size: .85rem;
      font-weight: 600;
      transition: background .2s;
    }
    .blocked-box button:hover { background: #4b5563; }

    /* â”€â”€ Throttle / Cooldown Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .throttle-overlay {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transform: translateX(120%);
      transition: transform .35s ease, opacity .25s ease;
    }
    .throttle-overlay.open {
      opacity: 1;
      pointer-events: auto;
      transform: translateX(0);
    }
    .throttle-box {
      background: var(--bg-card);
      border: 1px solid rgba(245,158,11,.3);
      border-radius: var(--radius-md);
      padding: 20px 24px;
      min-width: 280px;
      max-width: 340px;
      box-shadow: var(--shadow-lg);
    }
    .throttle-box .throttle-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .throttle-box .throttle-icon { font-size: 1.6rem; }
    .throttle-box .throttle-title {
      font-size: 1rem;
      font-weight: 700;
      color: #f59e0b;
    }
    .throttle-box p {
      color: #d1d5db;
      font-size: .82rem;
      line-height: 1.45;
      margin-bottom: 12px;
    }
    .throttle-timer {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    .throttle-timer .timer-ring {
      width: 44px;
      height: 44px;
      flex-shrink: 0;
    }
    .throttle-timer .timer-ring circle {
      fill: none;
      stroke-width: 4;
    }
    .throttle-timer .timer-ring .ring-bg {
      stroke: #374151;
    }
    .throttle-timer .timer-ring .ring-fg {
      stroke: #f59e0b;
      stroke-linecap: round;
      transition: stroke-dashoffset .95s linear;
    }
    .throttle-timer .timer-text {
      font-size: 1.3rem;
      font-weight: 700;
      color: #fbbf24;
      font-variant-numeric: tabular-nums;
    }
    .throttle-timer .timer-label {
      font-size: .75rem;
      color: #9ca3af;
    }
    .throttle-bar {
      height: 3px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    .throttle-bar .throttle-fill {
      height: 100%;
      background: #f59e0b;
      border-radius: 3px;
      transition: width .95s linear;
    }
    .throttle-box .dismiss-link {
      display: block;
      text-align: right;
      font-size: .72rem;
      color: var(--text-muted);
      cursor: pointer;
      text-decoration: none;
      opacity: .7;
      transition: opacity var(--transition);
    }
    .throttle-box .dismiss-link:hover { opacity: 1; }

    /* â”€â”€ ETA timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .eta-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    .eta-bar-outer {
      width: 240px;
      height: 4px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }
    .eta-bar-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent-soft));
      border-radius: 4px;
      transition: width 1s linear;
    }
    .eta-text {
      font-size: .82rem;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
    }
    .eta-text span {
      color: var(--accent-soft);
      font-weight: 600;
    }

    /* â”€â”€ Welcome / Landing Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .welcome {
      text-align: center;
      padding: 40px 20px 20px;
    }
    .welcome h2 {
      font-size: 1.6rem;
      color: #c4b5fd;
      margin-bottom: 8px;
    }
    .welcome .subtitle {
      color: #9ca3af;
      font-size: .92rem;
      margin-bottom: 28px;
      line-height: 1.5;
    }
    .welcome-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 14px;
      text-align: left;
    }
    .welcome-card {
      background: #1a1c2e;
      border: 1px solid #272a3a;
      border-radius: 12px;
      padding: 18px 20px;
      cursor: pointer;
      transition: all .2s;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .welcome-card:hover {
      border-color: #7c3aed;
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(124,58,237,.15);
    }
    .welcome-card .wc-name {
      font-size: 1rem;
      font-weight: 600;
      color: #e0e0e0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .welcome-card .wc-name .wc-icon {
      font-size: 1.25rem;
    }
    .welcome-card .wc-cache {
      font-size: .72rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .welcome-card .wc-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .wc-dot.fresh   { background: #34d399; }
    .wc-dot.stale   { background: #f59e0b; }
    .wc-dot.none    { background: #4b5563; }
    .wc-cache-text  { color: #6b7280; }
    .wc-cache-text.fresh { color: #34d399; }
    .wc-cache-text.stale { color: #f59e0b; }
    .wc-fresh-msg {
      background: #0d2818;
      border: 1px solid #166534;
      border-radius: 8px;
      padding: 10px 16px;
      margin-bottom: 18px;
      font-size: .82rem;
      color: #34d399;
      line-height: 1.4;
    }
    .wc-fresh-msg strong { color: #6ee7b7; }

    /* â”€â”€ Analysis / Compare â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .analysis-panel {
      margin-bottom: 24px;
    }
    .compare-form {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: flex-end;
      margin-bottom: 22px;
    }
    .compare-form label {
      font-size: .75rem;
      font-weight: 500;
      color: var(--text-secondary);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .compare-form input, .compare-form select {
      padding: 9px 14px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg-card);
      color: var(--text);
      font-family: var(--font);
      font-size: .84rem;
      min-width: 220px;
      transition: border-color var(--transition);
    }
    .compare-form input:focus, .compare-form select:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 0 3px rgba(124,58,237,.12);
    }
    .compare-btn {
      padding: 9px 22px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: var(--font);
      font-size: .82rem;
      font-weight: 600;
      transition: all var(--transition);
    }
    .compare-btn:hover {
      background: #6d28d9;
      box-shadow: 0 2px 12px rgba(124,58,237,.3);
    }

    .compare-result {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }
    @media (max-width: 700px) {
      .compare-result { grid-template-columns: 1fr; }
    }
    .compare-app-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 18px;
    }
    .compare-app-card .app-hdr {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }
    .compare-app-card .app-hdr img {
      width: 44px; height: 44px;
      border-radius: var(--radius-sm);
    }
    .compare-app-card .app-hdr .app-title {
      font-weight: 700;
      color: #fff;
    }
    .compare-app-card .app-hdr .app-dev {
      font-size: .75rem;
      color: var(--text-secondary);
    }

    .word-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 14px;
    }
    .word-section h3 {
      font-size: .9rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 10px;
    }
    .word-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }
    .word-chip {
      display: inline-block;
      padding: 3px 10px;
      border-radius: var(--radius-pill);
      font-size: .72rem;
      font-weight: 500;
    }
    .word-chip.shared  { background: rgba(30,58,95,.6); color: #60a5fa; border: 1px solid rgba(96,165,250,.15); }
    .word-chip.only1   { background: rgba(59,31,94,.6); color: #c084fc; border: 1px solid rgba(192,132,252,.15); }
    .word-chip.only2   { background: rgba(30,59,59,.6); color: var(--green); border: 1px solid rgba(52,211,153,.15); }

    .chart-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 18px;
      margin-bottom: 20px;
    }
    .chart-container canvas {
      max-height: 320px;
    }
    .overlap-badge {
      display: inline-block;
      padding: 4px 14px;
      border-radius: var(--radius-pill);
      font-size: .8rem;
      font-weight: 700;
      background: var(--accent-muted);
      border: 1px solid rgba(124,58,237,.2);
      color: var(--accent-soft);
      margin-bottom: 14px;
    }

    /* â”€â”€ Request Log Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar-toggle {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 10001;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--bg-card);
      color: var(--accent-soft);
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition);
      box-shadow: var(--shadow-md);
    }
    .sidebar-toggle:hover {
      border-color: var(--accent);
      background: var(--bg-hover);
      transform: scale(1.06);
    }
    .sidebar-toggle .badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--accent);
      color: #fff;
      font-size: .6rem;
      font-weight: 700;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
    }
    .sidebar-toggle .badge.has-error {
      background: var(--red);
    }
    .req-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 360px;
      height: 100vh;
      z-index: 10000;
      background: var(--bg-surface);
      border-left: 1px solid var(--border);
      transform: translateX(100%);
      transition: transform .3s ease;
      display: flex;
      flex-direction: column;
      box-shadow: -4px 0 24px rgba(0,0,0,.4);
    }
    .req-sidebar.open {
      transform: translateX(0);
    }
    .req-sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .req-sidebar-header h3 {
      font-size: .92rem;
      font-weight: 600;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .req-sidebar-header .clear-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      font-family: var(--font);
      font-size: .7rem;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition);
    }
    .req-sidebar-header .clear-btn:hover {
      border-color: rgba(248,113,113,.4);
      color: var(--red);
    }
    .req-sidebar-header .close-sb {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.3rem;
      cursor: pointer;
      margin-left: 8px;
      transition: color var(--transition);
    }
    .req-sidebar-header .close-sb:hover { color: var(--text); }
    .req-sidebar-list {
      flex: 1;
      overflow-y: auto;
      padding: 6px 0;
    }
    .req-sidebar-list::-webkit-scrollbar { width: 4px; }
    .req-sidebar-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    .req-sidebar-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 50px 20px;
      font-size: .82rem;
    }
    .req-entry {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 9px 18px;
      border-bottom: 1px solid var(--border-subtle);
      transition: background var(--transition);
      cursor: default;
    }
    .req-entry:hover {
      background: var(--bg-hover);
    }
    .req-entry .req-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-top: 6px;
      flex-shrink: 0;
    }
    .req-entry .req-dot.ok      { background: var(--green); }
    .req-entry .req-dot.fail    { background: var(--red); }
    .req-entry .req-dot.pending { background: var(--yellow); animation: pulse-dot 1s ease infinite; }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50%      { opacity: .3; }
    }
    .req-entry .req-body {
      flex: 1;
      min-width: 0;
    }
    .req-entry .req-url {
      font-size: .75rem;
      color: #d1d5db;
      font-family: 'SF Mono', 'Fira Code', 'Courier New', monospace;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .req-entry .req-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 3px;
      font-size: .68rem;
      color: var(--text-muted);
    }
    .req-entry .req-meta .status-ok   { color: var(--green); font-weight: 600; }
    .req-entry .req-meta .status-fail { color: var(--red); font-weight: 600; }
    .req-entry .req-reason {
      margin-top: 4px;
      font-size: .68rem;
      color: var(--red);
      line-height: 1.3;
      word-break: break-word;
    }
    .req-entry .req-time {
      font-size: .62rem;
      color: var(--text-muted);
      white-space: nowrap;
      margin-top: 5px;
      flex-shrink: 0;
    }
  </style>
</head>
<body>

<header>
  <h1>Google Play â€” Top 100 Apps</h1>
  <p>Most downloaded &amp; popular apps this week</p>
  <button class="proxy-status-btn" id="proxyStatusBtn" onclick="openProxyStatus()" title="Proxy Status">ğŸŒ Proxy Status</button>
</header>

<nav class="tabs" id="tabs">
  <button class="tab-btn active" data-endpoint="welcome">ğŸ  Home</button>
  <button class="tab-btn" data-endpoint="/api/top">All</button>
  <button class="tab-btn" data-endpoint="anime">ğŸŒ Anime</button>
  <button class="tab-btn" data-endpoint="niche-finder">ğŸ” Competition Analyzer</button>
  <button class="tab-btn" data-endpoint="analysis">ğŸ“Š Analysis</button>
  <!-- category buttons injected dynamically -->
</nav>

<!-- Add Category Modal -->
<div class="add-cat-overlay" id="addCatOverlay">
  <div class="add-cat-box">
    <h3>â• Add Custom Category</h3>
    <div class="form-row">
      <input type="text" id="catNameInput" placeholder="Category name (e.g. Pet Apps)" maxlength="40" style="flex:1">
      <input type="text" id="catEmojiInput" class="emoji-input" placeholder="ğŸ“‚" maxlength="4">
    </div>
    <textarea id="catQueriesInput" placeholder="Search queries, one per line or comma-separated (e.g. pet care app, dog tracker, cat food...)"></textarea>
    <div class="btn-row">
      <button class="btn-save" onclick="addCustomCategory()">Add Category</button>
      <button class="btn-cancel" onclick="closeAddCatModal()">Cancel</button>
    </div>
    <div id="catFormMsg" style="margin-top:8px;font-size:.8rem"></div>
  </div>
</div>

<!-- IP blocked modal -->
<div id="blockedOverlay" class="blocked-overlay">
  <div class="blocked-box">
    <div class="blocked-icon">ğŸš«</div>
    <h2>IP Temporarily Blocked</h2>
    <p id="blockedMsg">Google Play has rate-limited requests from this IP. Cached data is still available, but new scrapes will fail until the block expires.</p>
    <div class="countdown" id="blockedCountdown"></div>
    <button onclick="closeBlockedModal()">Dismiss</button>
  </div>
</div>

<!-- Throttle cooldown toast -->
<div id="throttleOverlay" class="throttle-overlay">
  <div class="throttle-box">
    <div class="throttle-header">
      <span class="throttle-icon">â³</span>
      <span class="throttle-title" id="throttleTitle">Cooldown Active</span>
    </div>
    <p id="throttleMsg">Waiting between requests to avoid getting blocked by Google Play.</p>
    <div class="throttle-timer">
      <svg class="timer-ring" viewBox="0 0 44 44">
        <circle class="ring-bg" cx="22" cy="22" r="18" />
        <circle class="ring-fg" id="throttleRing" cx="22" cy="22" r="18"
                stroke-dasharray="113.1" stroke-dashoffset="0" />
      </svg>
      <div>
        <div class="timer-text" id="throttleCountdown">10s</div>
        <div class="timer-label">remaining</div>
      </div>
    </div>
    <div class="throttle-bar"><div class="throttle-fill" id="throttleFill" style="width:100%"></div></div>
    <span class="dismiss-link" onclick="closeThrottleModal()">dismiss</span>
  </div>
</div>

<!-- Request Log Sidebar -->
<button class="sidebar-toggle" id="sidebarToggle" title="Request Log">
  ğŸ“‹<span class="badge" id="sidebarBadge" style="display:none">0</span>
</button>
<aside class="req-sidebar" id="reqSidebar">
  <div class="req-sidebar-header">
    <h3>ğŸ“‹ Request Log</h3>
    <div>
      <button class="clear-btn" id="clearLogBtn">Clear</button>
      <button class="close-sb" id="closeSidebar">&times;</button>
    </div>
  </div>
  <div class="req-sidebar-list" id="reqList">
    <div class="req-sidebar-empty">No requests yet</div>
  </div>
</aside>

<main id="content">
  <!-- cards rendered here -->
</main>

<footer>
  Data sourced from Google Play via google-play-scraper &middot; refreshed on each request
</footer>

<!-- App Detail Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal-body" id="modalBody">
    <button class="modal-close" id="modalClose">&times;</button>
    <div id="modalContent"></div>
  </div>
</div>

<script>
  const $content = document.getElementById("content");
  const $tabs    = document.getElementById("tabs");
  const $blockedOverlay = document.getElementById("blockedOverlay");
  const $blockedMsg     = document.getElementById("blockedMsg");
  const $blockedCount   = document.getElementById("blockedCountdown");
  let _blockedTimer     = null;

  // â”€â”€ IP-blocked modal helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showBlockedModal(message) {
    $blockedMsg.textContent = message || $blockedMsg.textContent;
    $blockedOverlay.classList.add("open");

    let secs = 120;
    clearInterval(_blockedTimer);
    tick();
    _blockedTimer = setInterval(tick, 1000);
    function tick() {
      const m = Math.floor(secs / 60);
      const s = String(secs % 60).padStart(2, "0");
      $blockedCount.textContent = `Suggested wait: ${m}:${s}`;
      if (secs <= 0) {
        clearInterval(_blockedTimer);
        $blockedCount.textContent = "You can try again now.";
      }
      secs--;
    }
  }
  function closeBlockedModal() {
    $blockedOverlay.classList.remove("open");
    clearInterval(_blockedTimer);
  }

  // â”€â”€ Proxy Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function openProxyStatus() {
    const $modal = document.getElementById("modal");
    const $modalContent = document.getElementById("modalContent");

    $modalContent.innerHTML = `
      <div class="loading" style="padding:40px 0">
        <div class="spinner"></div>
        Loading proxy statusâ€¦
      </div>`;
    $modal.classList.add("open");

    try {
      const res = await fetch("/api/proxy-status");
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      let html = `<h2 style="margin:0 0 6px;color:#a78bfa">ğŸŒ Proxy Status</h2>`;
      html += `<p style="color:#9ca3af;font-size:.85rem;margin-bottom:16px">${data.usingProxies ? 'Requests are routed through proxies' : 'No proxies configured â€” using direct connection'}</p>`;

      // Stats cards
      html += `<div class="proxy-stat">`;
      html += `<div class="proxy-stat-card">
        <div class="psc-value" style="color:#34d399">${data.alive}</div>
        <div class="psc-label">Alive</div>
      </div>`;
      html += `<div class="proxy-stat-card">
        <div class="psc-value" style="color:#f87171">${data.dead.length}</div>
        <div class="psc-label">Dead</div>
      </div>`;
      html += `<div class="proxy-stat-card">
        <div class="psc-value" style="color:#c4b5fd">${data.total}</div>
        <div class="psc-label">Total</div>
      </div>`;
      html += `</div>`;

      // Proxy list
      if (data.total === 0) {
        html += `<ul class="proxy-list"><li class="direct">âš¡ Direct connection (no proxies in .env)</li></ul>`;
      } else {
        html += `<h3 style="margin:18px 0 8px;font-size:.9rem;color:#e5e7eb">Proxy Pool</h3>`;
        html += `<ul class="proxy-list">`;
        // We don't have the full proxy list from the API (only dead ones),
        // so show alive count + dead list
        const aliveCount = data.alive;
        if (aliveCount > 0) {
          html += `<li class="alive">âœ“ ${aliveCount} prox${aliveCount === 1 ? 'y' : 'ies'} active and healthy</li>`;
        }
        for (const p of data.dead) {
          // Mask credentials in the URL for display
          const masked = p.replace(/:\/\/([^:]+):([^@]+)@/, '://*****:*****@');
          html += `<li class="dead">âœ• ${masked}</li>`;
        }
        html += `</ul>`;
      }

      $modalContent.innerHTML = html;
    } catch (err) {
      $modalContent.innerHTML = `<div class="error">âš ï¸ Failed to load proxy status: ${err.message}</div>`;
    }
  }

  // â”€â”€ Request Log sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const $reqSidebar  = document.getElementById("reqSidebar");
  const $reqList     = document.getElementById("reqList");
  const $sidebarBadge = document.getElementById("sidebarBadge");
  const _requestLog  = [];    // {id, url, status, statusText, duration, error, time}
  let _reqIdCounter  = 0;

  document.getElementById("sidebarToggle").addEventListener("click", () => {
    $reqSidebar.classList.toggle("open");
  });
  document.getElementById("closeSidebar").addEventListener("click", () => {
    $reqSidebar.classList.remove("open");
  });
  document.getElementById("clearLogBtn").addEventListener("click", () => {
    _requestLog.length = 0;
    _renderReqLog();
  });

  function _addReqEntry(entry) {
    _requestLog.unshift(entry);  // newest first
    if (_requestLog.length > 200) _requestLog.pop();
    _renderReqLog();
  }

  function _updateReqEntry(id, updates) {
    const e = _requestLog.find(r => r.id === id);
    if (e) Object.assign(e, updates);
    _renderReqLog();
  }

  function _renderReqLog() {
    const errorCount = _requestLog.filter(r => r.status === 'error').length;
    const total = _requestLog.length;

    // Badge
    if (total > 0) {
      $sidebarBadge.style.display = '';
      $sidebarBadge.textContent = total > 99 ? '99+' : total;
      $sidebarBadge.classList.toggle('has-error', errorCount > 0);
    } else {
      $sidebarBadge.style.display = 'none';
    }

    if (total === 0) {
      $reqList.innerHTML = '<div class="req-sidebar-empty">No requests yet</div>';
      return;
    }

    let html = '';
    for (const r of _requestLog) {
      const dotClass = r.status === 'pending' ? 'pending'
                     : r.status === 'error'   ? 'fail'
                     : 'ok';
      const statusLabel = r.status === 'pending'
        ? '<span style="color:#f59e0b">pendingâ€¦</span>'
        : r.status === 'error'
          ? `<span class="status-fail">${_escLog(r.statusCode || 'ERR')}</span>`
          : `<span class="status-ok">${r.statusCode || '200'}</span>`;
      const durLabel = r.duration != null ? (r.duration < 1000 ? r.duration + 'ms' : (r.duration / 1000).toFixed(1) + 's') : '';
      const shortUrl = r.url.replace(/^\/api\//, '');
      html += `
        <div class="req-entry">
          <div class="req-dot ${dotClass}"></div>
          <div class="req-body">
            <div class="req-url" title="${_escLog(r.url)}">${_escLog(shortUrl)}</div>
            <div class="req-meta">
              ${statusLabel}
              ${durLabel ? '<span>Â· ' + durLabel + '</span>' : ''}
            </div>
            ${r.error ? '<div class="req-reason">âš  ' + _escLog(r.error) + '</div>' : ''}
          </div>
          <div class="req-time">${r.timeStr}</div>
        </div>`;
    }
    $reqList.innerHTML = html;
  }

  function _escLog(s) {
    const d = document.createElement('div');
    d.textContent = String(s || '');
    return d.innerHTML;
  }

  function _nowTimeStr() {
    const d = new Date();
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  }

  /** Wrapper around fetch that auto-detects 429 blocked responses
   *  and logs every request to the sidebar. */
  async function apiFetch(url, opts) {
    const reqId = ++_reqIdCounter;
    const t0 = performance.now();
    _addReqEntry({
      id: reqId,
      url: url,
      status: 'pending',
      statusCode: null,
      duration: null,
      error: null,
      timeStr: _nowTimeStr(),
    });

    try {
      const res = await fetch(url, opts);
      const dur = Math.round(performance.now() - t0);

      if (res.status === 429) {
        let msg = '';
        try { const body = await res.clone().json(); msg = body.error || ''; } catch (_) {}
        _updateReqEntry(reqId, { status: 'error', statusCode: '429', duration: dur, error: msg || 'IP blocked (429)' });
        showBlockedModal(msg);
        throw new Error(msg || 'IP blocked (429)');
      }

      if (!res.ok) {
        _updateReqEntry(reqId, { status: 'error', statusCode: String(res.status), duration: dur, error: res.statusText });
      } else {
        _updateReqEntry(reqId, { status: 'ok', statusCode: String(res.status), duration: dur });
      }
      return res;
    } catch (err) {
      const dur = Math.round(performance.now() - t0);
      if (err.name === 'AbortError') {
        _updateReqEntry(reqId, { status: 'error', statusCode: 'ABORT', duration: dur, error: 'Request cancelled (tab switch)' });
      } else {
        // Only update if not already set (e.g. by 429 handler above)
        const existing = _requestLog.find(r => r.id === reqId);
        if (existing && existing.status === 'pending') {
          _updateReqEntry(reqId, { status: 'error', statusCode: 'ERR', duration: dur, error: err.message });
        }
      }
      throw err;
    }
  }

  // â”€â”€ Throttle / Cooldown toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const $throttleOverlay = document.getElementById("throttleOverlay");
  const $throttleTitle   = document.getElementById("throttleTitle");
  const $throttleMsg     = document.getElementById("throttleMsg");
  const $throttleCount   = document.getElementById("throttleCountdown");
  const $throttleRing    = document.getElementById("throttleRing");
  const $throttleFill    = document.getElementById("throttleFill");
  let _throttleTimer     = null;
  let _lastTabClick      = 0;        // timestamp of last tab switch
  const TAB_COOLDOWN     = 10;       // seconds between tab switches
  const RING_CIRCUM      = 113.1;    // 2Ï€r for r=18

  function showThrottleModal(totalSecs, title, msg) {
    $throttleTitle.textContent = title || "Cooldown Active";
    $throttleMsg.textContent   = msg   || "Waiting between requests to avoid getting blocked by Google Play.";
    $throttleOverlay.classList.add("open");

    let remaining = totalSecs;
    clearInterval(_throttleTimer);
    updateRing(remaining, totalSecs);
    _throttleTimer = setInterval(() => {
      remaining--;
      updateRing(remaining, totalSecs);
      if (remaining <= 0) {
        clearInterval(_throttleTimer);
        setTimeout(() => $throttleOverlay.classList.remove("open"), 600);
      }
    }, 1000);
  }

  function updateRing(remaining, total) {
    const pct = Math.max(0, remaining / total);
    $throttleCount.textContent = remaining + "s";
    $throttleRing.style.strokeDashoffset = RING_CIRCUM * (1 - pct);
    $throttleFill.style.width = (pct * 100) + "%";
  }

  function closeThrottleModal() {
    $throttleOverlay.classList.remove("open");
    clearInterval(_throttleTimer);
  }

  /**
   * Check if user is switching tabs too fast.
   * Returns true if the request should proceed, false if throttled.
   */
  function checkTabCooldown() {
    const now = Date.now() / 1000;
    const elapsed = now - _lastTabClick;
    if (_lastTabClick > 0 && elapsed < TAB_COOLDOWN) {
      const wait = Math.ceil(TAB_COOLDOWN - elapsed);
      showThrottleModal(wait,
        "Slow Down â€” Cooldown",
        "Switching tabs too fast can trigger rate limits. Please wait."
      );
      return false;
    }
    _lastTabClick = now;
    return true;
  }

  /**
   * Poll the backend throttle status and show/update the toast
   * while a scrape request is in flight.
   */
  async function pollThrottleWhileLoading(signal) {
    try {
      const res = await fetch("/api/throttle-status", { signal });
      if (!res.ok) return;
      const data = await res.json();
      if (data.waiting && data.waitSeconds > 0) {
        showThrottleModal(
          Math.ceil(data.waitSeconds),
          "Database Delay Active",
          "The scraper is waiting to respect rate limits. Data will load automatically."
        );
      }
    } catch (_) { /* ignore */ }
  }

  // â”€â”€ Render helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let _etaTimer = null;

  function _startEtaCountdown(totalSecs) {
    clearInterval(_etaTimer);
    let elapsed = 0;
    const $bar   = document.getElementById("etaBar");
    const $count = document.getElementById("etaCount");
    if (!$bar || !$count) return;
    _etaTimer = setInterval(() => {
      elapsed++;
      const pct = Math.min(100, (elapsed / totalSecs) * 100);
      $bar.style.width = pct + "%";
      const remaining = Math.max(0, Math.ceil(totalSecs - elapsed));
      if (remaining > 0) {
        $count.textContent = _fmtEta(remaining);
      } else {
        $count.textContent = "almost doneâ€¦";
      }
    }, 1000);
  }

  function _fmtEta(secs) {
    if (secs < 60) return secs + "s";
    const m = Math.floor(secs / 60);
    const s = secs % 60;
    return m + "m " + (s < 10 ? "0" : "") + s + "s";
  }

  function _stopEtaCountdown() {
    clearInterval(_etaTimer);
    _etaTimer = null;
  }

  function showLoading(etaSeconds) {
    let etaHtml = '';
    if (etaSeconds && etaSeconds > 0) {
      const fmtEta = etaSeconds < 60
        ? Math.ceil(etaSeconds) + "s"
        : Math.floor(etaSeconds / 60) + "m " + (Math.ceil(etaSeconds % 60) < 10 ? "0" : "") + Math.ceil(etaSeconds % 60) + "s";
      etaHtml = `
        <div class="eta-wrap">
          <div class="eta-bar-outer"><div class="eta-bar-inner" id="etaBar"></div></div>
          <div class="eta-text">
            Estimated time: <span id="etaCount">${fmtEta}</span>
          </div>
        </div>`;
    }
    $content.innerHTML = `
      <div class="loading">
        <div class="spinner"></div>
        Fetching data from Google Playâ€¦ this may take a minute.
        ${etaHtml}
      </div>`;

    if (etaSeconds && etaSeconds > 0) {
      _startEtaCountdown(etaSeconds);
    }
  }

  function showError(msg) {
    $content.innerHTML = `<div class="error">âš ï¸ ${msg}</div>`;
  }

  /**
   * Staggered image loader â€” loads images in small batches with delays
   * to prevent Googleâ€™s image CDN from returning 429.
   */
  let _imgLoadAbort = null;
  function loadImagesStaggered(container) {
    // Cancel any previous staggered load
    if (_imgLoadAbort) _imgLoadAbort.abort = true;
    const ctrl = { abort: false };
    _imgLoadAbort = ctrl;

    const imgs = (container || document).querySelectorAll("img[data-src]");
    if (!imgs.length) return;

    const BATCH = 6;       // images per batch
    const DELAY = 300;     // ms between batches
    let i = 0;

    function loadBatch() {
      if (ctrl.abort) return;
      const end = Math.min(i + BATCH, imgs.length);
      for (; i < end; i++) {
        const img = imgs[i];
        if (img.dataset.src) {
          img.src = img.dataset.src;
          img.removeAttribute("data-src");
        }
      }
      if (i < imgs.length) {
        setTimeout(loadBatch, DELAY);
      }
    }
    // Start first batch after a very short tick
    setTimeout(loadBatch, 50);
  }

  function renderApps(title, apps) {
    let html = `<h2 class="section-title">${title} (${apps.length} apps)</h2><div class="grid" id="appGrid">`;
    for (const app of apps) {
      const topClass = app.rank <= 3 ? "top3" : "";
      const stars = app.score ? "â­ " + app.score.toFixed(1) : "";
      html += `
        <div class="card-link" data-appid="${esc(app.appId)}" style="cursor:pointer" data-rank="${app.rank}" data-score="${app.score||0}" data-installs="${app.realInstalls||0}" data-free="${app.free?1:0}" data-dev="${esc(app.developer)}">
          <div class="card">
            <button class="bookmark-star" data-appid="${esc(app.appId)}" onclick="event.stopPropagation();toggleBookmark('${esc(app.appId)}')" title="Bookmark">â˜†</button>
            <span class="rank ${topClass}">#${app.rank}</span>
            <img class="icon" data-src="${app.icon}" alt="" loading="lazy" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='56' height='56'%3E%3Crect fill='%23272a3a' width='56' height='56' rx='12'/%3E%3C/svg%3E" />
            <div class="info">
              <div class="name" title="${esc(app.title)}">${esc(app.title)}</div>
              <div class="dev">${esc(app.developer)}</div>
            </div>
            <div class="meta">
              <div class="installs">${app.installs}</div>
              <div class="rating">${stars}</div>
              <div class="genre">${esc(app.genre)}</div>
            </div>
          </div>
        </div>`;
    }
    html += `</div>`;
    return html;
  }

  function renderKeywords(title, keywords) {
    let html = `<div class="keywords-section">`;
    html += `<h2 class="section-title">${title} (${keywords.length} keywords)</h2>`;
    html += `<div class="keywords-grid">`;
    keywords.forEach((kw, i) => {
      html += `
        <div class="kw-pill">
          <span class="kw-rank">#${i + 1}</span>
          <span class="kw-name">${esc(kw.keyword)}</span>
          <span class="kw-count">${kw.resultCount} apps</span>
        </div>`;
    });
    html += `</div></div>`;
    return html;
  }

  function esc(str) {
    const d = document.createElement("div");
    d.textContent = str || "";
    return d.innerHTML;
  }

  // â”€â”€ Fetch & display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let _activeController = null;  // AbortController for the current load

  /**
   * Map a frontend endpoint string to the backend timing key used
   * in the request_timing table.
   */
  function _endpointToTimingKey(ep) {
    if (ep === "/api/top")  return "top";
    if (ep === "anime")     return "anime:apps";       // longest sub-request
    if (ep === "niche-finder") return "niche_finder";
    if (ep === "analysis")  return "top";               // loads /api/top
    const catMatch = ep.match(/\/api\/category\/(.+)/);
    if (catMatch) return "category:" + catMatch[1];
    return null;
  }

  /**
   * Fetch estimated duration from the backend for the given timing key.
   * Returns seconds (number) or null if unknown.
   */
  async function _fetchEta(timingKey) {
    if (!timingKey) return null;
    try {
      const res = await fetch("/api/eta?endpoint=" + encodeURIComponent(timingKey));
      if (!res.ok) return null;
      const data = await res.json();
      return data.estimatedSeconds || null;
    } catch (_) { return null; }
  }

  async function loadEndpoint(endpoint) {
    // Welcome page (no scraping needed)
    if (endpoint === "welcome") {
      if (_activeController) _activeController.abort();
      // Refresh cache status before re-rendering
      try {
        const res = await fetch("/api/cache-status");
        const data = await res.json();
        _cacheStatus = data.cache || {};
        _ttlHours    = data.ttlHours || 6;
      } catch (_) {}
      _renderWelcome();
      return;
    }

    // Cancel any in-flight request (user switched tabs fast)
    if (_activeController) _activeController.abort();
    _activeController = new AbortController();
    const signal = _activeController.signal;

    // Start polling backend throttle status after a short delay
    const pollTimer = setTimeout(() => pollThrottleWhileLoading(signal), 1500);

    if (endpoint === "anime") {
      return loadAnime(signal).finally(() => { clearTimeout(pollTimer); _stopEtaCountdown(); });
    }
    if (endpoint === "niche-finder" || endpoint.startsWith("niche-finder:")) {
      const autoScoreNiche = endpoint.startsWith("niche-finder:") ? endpoint.slice("niche-finder:".length) : null;
      return loadNicheFinder(signal, autoScoreNiche).finally(() => { clearTimeout(pollTimer); _stopEtaCountdown(); });
    }
    if (endpoint === "analysis") {
      return loadAnalysis(signal).finally(() => { clearTimeout(pollTimer); _stopEtaCountdown(); });
    }

    // Fetch ETA for this endpoint, show loading with estimate
    const timingKey = _endpointToTimingKey(endpoint);
    const eta = await _fetchEta(timingKey);
    showLoading(eta);
    try {
      const res = await apiFetch(endpoint, { signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (data.error) throw new Error(data.error);

      // Determine export key
      let exportKey = "top";
      const catMatch = endpoint.match(/\/api\/category\/(.+)/);
      if (catMatch) exportKey = catMatch[1];

      // Store apps for filtering
      _currentApps = data.apps;
      _currentTitle = data.title;
      _currentExportKey = exportKey;

      let html = renderToolbar(exportKey);
      html += _renderCacheBanner(exportKey);
      html += renderApps(data.title, data.apps);
      $content.innerHTML = html;

      // DOM-modifying functions (must run after innerHTML is set)
      renderInsightsPanel(data.apps);
      renderFilterBar(data.apps);
      _attachFilterListeners();
      loadImagesStaggered($content);
      _loadBookmarkStars(data.apps);
      closeThrottleModal();
      // Refresh cache status in background for the welcome page
      _refreshCacheStatus();
    } catch (err) {
      if (err.name === "AbortError") return; // user switched tabs
      showError(err.message);
    } finally {
      clearTimeout(pollTimer);
      _stopEtaCountdown();
    }
  }

  async function loadAnime(signal) {
    const eta = await _fetchEta("anime:apps");
    showLoading(eta);
    try {
      // Fetch keywords and apps sequentially to avoid parallel bursts
      const kwRes = await apiFetch("/api/anime/keywords", { signal });
      if (!kwRes.ok) throw new Error(`Keywords: HTTP ${kwRes.status}`);
      const kwData = await kwRes.json();

      const appRes = await apiFetch("/api/anime/apps", { signal });
      if (!appRes.ok) throw new Error(`Apps: HTTP ${appRes.status}`);
      const appData = await appRes.json();

      let html = "";
      html += renderKeywords(kwData.title, kwData.keywords);
      html += renderApps(appData.title, appData.apps);
      $content.innerHTML = html;
      loadImagesStaggered($content);
    } catch (err) {
      if (err.name === "AbortError") return;
      showError(err.message);
    }
  }

  // â”€â”€ Tab behaviour â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $tabs.addEventListener("click", (e) => {
    const btn = e.target.closest(".tab-btn");
    if (!btn) return;
    const endpoint = btn.dataset.endpoint;
    // Check cooldown BEFORE switching visual state (welcome is exempt)
    if (endpoint !== "welcome" && !checkTabCooldown()) return;
    $tabs.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    loadEndpoint(endpoint);
  });

  // â”€â”€ Init: load categories, build welcome page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const CATEGORY_ICONS = {
    "All":             "ğŸ“±", "Games":          "ğŸ®", "Social":          "ğŸ’¬",
    "Entertainment":   "ğŸ¬", "Productivity":   "âš¡", "Anime":           "ğŸŒ",
    "Health":          "â¤ï¸", "Finance":         "ğŸ’°", "Education":       "ğŸ“š",
    "AI":              "ğŸ¤–", "Crypto":          "â‚¿",  "Shopping":        "ğŸ›’",
    "Food":            "ğŸ”", "Travel":          "âœˆï¸", "Music":           "ğŸµ",
    "Photography":     "ğŸ“·", "Art & Design":    "ğŸ¨", "Auto & Vehicles": "ğŸš—",
    "Beauty":          "ğŸ’„", "Books & Reference":"ğŸ“–","Business":        "ğŸ’¼",
    "Comics":          "ğŸ’¬", "Communication":   "ğŸ“", "Dating":          "ğŸ’•",
    "Events":          "ğŸŸï¸", "House & Home":    "ğŸ ", "Libraries & Demo":"ğŸ“š",
    "Lifestyle":       "ğŸŒ¿", "Maps & Navigation":"ğŸ—ºï¸","Medical":         "ğŸ¥",
    "News & Magazines":"ğŸ“°", "Parenting":       "ğŸ‘¶", "Personalization": "ğŸ¨",
    "Sports":          "âš½", "Tools":           "ğŸ”§", "Video Players":   "â–¶ï¸",
    "Weather":         "ğŸŒ¤ï¸",
  };

  let _categories = [];
  let _customCategoryMap = {};  // { name: emoji } for custom categories
  let _customNiches = [];  // [{name, keywordCount, builtin}]
  let _cacheStatus = {};   // label -> {fetchedAt, ageMinutes, fresh}
  let _ttlHours = 6;

  // New feature state
  let _currentApps = [];
  let _currentTitle = "";
  let _currentExportKey = "top";
  let _bookmarkedIds = new Set();

  function _timeAgo(minutes) {
    if (minutes < 1)   return "just now";
    if (minutes < 60)  return Math.round(minutes) + "m ago";
    const h = Math.floor(minutes / 60);
    const m = Math.round(minutes % 60);
    return h + "h " + m + "m ago";
  }

  /**
   * Map endpoint to cache label for lookup.
   */
  function _endpointToCacheLabel(ep) {
    if (ep === "/api/top" || ep === "top") return "All (Top 100)";
    if (ep === "anime") return "Anime";
    const catMatch = ep.match(/\/api\/category\/(.+)/);
    if (catMatch) return catMatch[1];
    return null;
  }

  /**
   * Render a small info banner showing cache status for the loaded data.
   */
  function _renderCacheBanner(exportKey) {
    const label = exportKey === "top" ? "All (Top 100)" : exportKey;
    const ci = _cacheStatus[label];
    if (!ci) return '';
    if (ci.fresh) {
      return `<div class="wc-fresh-msg" style="margin-top:0;margin-bottom:14px">
        âœ“ <strong>Loaded from cache</strong> â€” scraped ${_timeAgo(ci.ageMinutes)}.
        No new request was needed. Cache valid for ${_ttlHours}h.
      </div>`;
    }
    return '';
  }

  /** Silently refresh cache status in the background. */
  async function _refreshCacheStatus() {
    try {
      const res = await fetch("/api/cache-status");
      const data = await res.json();
      _cacheStatus = data.cache || {};
      _ttlHours    = data.ttlHours || 6;
    } catch (_) {}
  }

  function _renderWelcome() {
    // Build list of all loadable categories
    const entries = [
      { name: "All (Top 100)", icon: "ğŸ“±", endpoint: "/api/top",             cacheLabel: "All (Top 100)" },
      { name: "Anime",         icon: "ğŸŒ", endpoint: "anime",                cacheLabel: "Anime" },
      { name: "Competition Analyzer",  icon: "ğŸ”", endpoint: "niche-finder",         cacheLabel: null },
      { name: "Analysis",      icon: "ğŸ“Š", endpoint: "analysis",             cacheLabel: null },
    ];
    for (const cat of _categories) {
      entries.push({
        name: cat,
        icon: _customCategoryMap[cat] || CATEGORY_ICONS[cat] || "ğŸ“‚",
        endpoint: `/api/category/${cat}`,
        cacheLabel: cat,
        isCustomCat: _customCategoryMap[cat] !== undefined,
      });
    }
    // Add custom (non-builtin) niches
    for (const n of _customNiches) {
      if (!n.builtin) {
        entries.push({
          name: `ğŸ” ${n.name}`,
          icon: "ğŸ”",
          endpoint: `niche-finder:${n.name}`,
          cacheLabel: null,
        });
      }
    }

    // Count how many are fresh
    const freshCount = entries.filter(e => e.cacheLabel && _cacheStatus[e.cacheLabel]?.fresh).length;

    let html = `<div class="welcome">`;
    html += `<h2>Welcome â€” What would you like to explore?</h2>`;
    html += `<p class="subtitle">Pick a category below to load its top apps from Google Play.<br>
              Scraping may take several minutes for fresh data. Cached results load instantly.</p>`;

    if (freshCount > 0) {
      html += `<div class="wc-fresh-msg">
        <strong>âœ“ ${freshCount} categor${freshCount === 1 ? 'y has' : 'ies have'} cached data</strong> â€”
        these will load instantly without any delay. Cache is valid for ${_ttlHours} hours.
      </div>`;
    }

    html += `<div class="welcome-grid">`;
    for (const e of entries) {
      const ci = e.cacheLabel ? _cacheStatus[e.cacheLabel] : null;
      let dotClass, cacheText;
      if (!ci) {
        dotClass  = "none";
        cacheText = "not yet scraped";
      } else if (ci.fresh) {
        dotClass  = "fresh";
        cacheText = "cached " + _timeAgo(ci.ageMinutes);
      } else {
        dotClass  = "stale";
        cacheText = "stale â€” " + _timeAgo(ci.ageMinutes);
      }
      html += `
        <div class="welcome-card" onclick="_launchEndpoint('${e.endpoint}')">
          <div class="wc-name">
            <span class="wc-icon">${e.icon}</span>
            ${e.name}
          </div>
          <div class="wc-cache">
            <span class="wc-dot ${dotClass}"></span>
            <span class="wc-cache-text ${dotClass}">${cacheText}</span>
          </div>
        </div>`;
    }
    html += `</div></div>`;
    $content.innerHTML = html;
  }

  /** Launch an endpoint from the welcome page (simulates tab click). */
  function _launchEndpoint(endpoint) {
    // Check cooldown BEFORE switching visual state (welcome is exempt)
    if (endpoint !== "welcome" && !checkTabCooldown()) return;
    // Highlight the matching tab if it exists
    const allBtns = $tabs.querySelectorAll(".tab-btn");
    allBtns.forEach(b => {
      b.classList.toggle("active", b.dataset.endpoint === endpoint);
    });
    loadEndpoint(endpoint);
  }

  (async () => {
    // 1. Load category list
    try {
      const res = await fetch("/api/categories");
      const { categories, customCategories } = await res.json();
      _categories = categories;
      _customCategoryMap = customCategories || {};
      _rebuildCategoryTabs();
    } catch (_) {}

    // 2. Load niche list (lightweight, no scraping)
    try {
      const res = await fetch("/api/niches");
      const data = await res.json();
      _customNiches = data.niches || [];
    } catch (_) {}

    // 3. Load cache status (lightweight, no scraping)
    try {
      const res = await fetch("/api/cache-status");
      const data = await res.json();
      _cacheStatus = data.cache || {};
      _ttlHours    = data.ttlHours || 6;
    } catch (_) {}

    // 4. Show welcome page instead of auto-loading
    _renderWelcome();
  })();

  // â”€â”€ Modal logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const $modal        = document.getElementById("modal");
  const $modalContent = document.getElementById("modalContent");
  const $modalClose   = document.getElementById("modalClose");

  // Close modal
  $modalClose.addEventListener("click", () => $modal.classList.remove("open"));
  $modal.addEventListener("click", (e) => {
    if (e.target === $modal) $modal.classList.remove("open");
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      $modal.classList.remove("open");
      closeAddCatModal();
    }
  });

  // Open modal on card click
  $content.addEventListener("click", (e) => {
    const link = e.target.closest(".card-link[data-appid]");
    if (!link) return;
    e.preventDefault();
    const appId = link.dataset.appid;
    openAppDetail(appId);
  });

  async function openAppDetail(appId) {
    $modalContent.innerHTML = `
      <div class="loading" style="padding:40px 0">
        <div class="spinner"></div>
        Loading app detailsâ€¦
      </div>`;
    $modal.classList.add("open");

    try {
      const res = await apiFetch(`/api/app/${encodeURIComponent(appId)}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const app = await res.json();
      if (app.error) throw new Error(app.error);
      const noteHtml = await renderNoteSection(appId);
      $modalContent.innerHTML = renderDetail(app) + noteHtml;
    } catch (err) {
      $modalContent.innerHTML = `<div class="error">âš ï¸ ${esc(err.message)}</div>`;
    }
  }

  function formatNumber(n) {
    if (n >= 1_000_000_000) return (n / 1_000_000_000).toFixed(1) + "B";
    if (n >= 1_000_000)     return (n / 1_000_000).toFixed(1) + "M";
    if (n >= 1_000)         return (n / 1_000).toFixed(1) + "K";
    return String(n);
  }

  function renderDetail(app) {
    const stars = app.score ? "â­ " + app.score.toFixed(1) : "N/A";
    const priceText = app.free ? "Free" : `$${app.price}`;

    // Screenshots
    let screenshotHtml = "";
    if (app.screenshots && app.screenshots.length) {
      screenshotHtml = `<div class="detail-screenshots">`;
      for (const src of app.screenshots) {
        screenshotHtml += `<img src="${src}" alt="screenshot" loading="lazy" />`;
      }
      screenshotHtml += `</div>`;
    }

    return `
      <div class="detail-header">
        <img src="${app.icon}" alt="" />
        <div>
          <div class="detail-title">${esc(app.title)}</div>
          <div class="detail-dev">${esc(app.developer)}</div>
          <span class="detail-genre-badge">${esc(app.genre)} Â· ${esc(app.contentRating || "N/A")}</span>
        </div>
      </div>

      <div class="detail-stats">
        <div class="stat-card">
          <div class="stat-value">${app.installs}</div>
          <div class="stat-label">Downloads</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${formatNumber(app.realInstalls)}</div>
          <div class="stat-label">Actual Installs</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stars}</div>
          <div class="stat-label">Rating</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${formatNumber(app.ratings || 0)}</div>
          <div class="stat-label">Ratings</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${formatNumber(app.reviews || 0)}</div>
          <div class="stat-label">Reviews</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${priceText}</div>
          <div class="stat-label">Price</div>
        </div>
      </div>

      <h3 class="section-title" style="font-size:1rem;margin-bottom:8px">Description</h3>
      <div class="detail-description">${esc(app.description)}</div>

      ${screenshotHtml}

      <div class="detail-footer">
        <a href="${app.url}" target="_blank" rel="noopener">View on Google Play â†—</a>
        <div class="detail-meta-info">
          ${app.released ? "Published: " + esc(app.released) + "<br>" : ""}
          ${app.lastUpdatedOn ? "Updated: " + esc(app.lastUpdatedOn) + "<br>" : ""}
          ${app.version ? "Version: " + esc(app.version) : ""}
        </div>
      </div>
    `;
  }

  // â”€â”€ Toolbar (export + snapshot) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderToolbar(exportKey) {
    return `
      <div class="toolbar">
        <button class="toolbar-btn" onclick="exportCSV('${exportKey}')">ğŸ“¥ Export CSV</button>
        <button class="toolbar-btn" onclick="takeSnapshot()">ğŸ“¸ Save Snapshot</button>
        <button class="toolbar-btn" onclick="showDiff('general_top')">ğŸ“Š Compare Snapshots</button>
      </div>`;
  }

  function exportCSV(key) {
    window.open(`/api/export/${encodeURIComponent(key)}`, "_blank");
  }

  async function takeSnapshot() {
    try {
      const res = await apiFetch("/api/snapshot/save", { method: "POST" });
      const data = await res.json();
      alert(`Snapshot saved! Keys: ${data.keys.join(", ")}`);
    } catch (err) {
      alert("Failed to save snapshot: " + err.message);
    }
  }

  async function showDiff(snapKey) {
    $modalContent.innerHTML = `
      <div class="loading" style="padding:40px 0">
        <div class="spinner"></div>
        Comparing snapshotsâ€¦
      </div>`;
    $modal.classList.add("open");

    try {
      const res = await apiFetch(`/api/snapshot/${encodeURIComponent(snapKey)}/diff`);
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      $modalContent.innerHTML = renderDiff(data);
    } catch (err) {
      $modalContent.innerHTML = `<div class="error">âš ï¸ ${esc(err.message)}</div>`;
    }
  }

  function renderDiff(diff) {
    let html = `<h2 class="section-title" style="margin-bottom:6px">${esc(diff.key)} â€“ Snapshot Diff</h2>`;
    html += `<p style="font-size:.75rem;color:#6b7280;margin-bottom:16px">${diff.previousDate} â†’ ${diff.currentDate}</p>`;

    // New apps
    html += `<div class="diff-section"><h3>ğŸ†• New Apps (${diff.newApps.length})</h3>`;
    if (diff.newApps.length === 0) html += `<p style="font-size:.82rem;color:#6b7280">None</p>`;
    for (const a of diff.newApps) {
      html += `<div class="diff-item">${esc(a.title)} â€” ${formatNumber(a.realInstalls || 0)} installs</div>`;
    }
    html += `</div>`;

    // Dropped apps
    html += `<div class="diff-section"><h3>âŒ Dropped Apps (${diff.droppedApps.length})</h3>`;
    if (diff.droppedApps.length === 0) html += `<p style="font-size:.82rem;color:#6b7280">None</p>`;
    for (const a of diff.droppedApps) {
      html += `<div class="diff-item">${esc(a.title)} â€” ${formatNumber(a.realInstalls || 0)} installs</div>`;
    }
    html += `</div>`;

    // Install changes
    html += `<div class="diff-section"><h3>ğŸ“ˆ Install Changes (top ${diff.installChanges.length})</h3>`;
    for (const c of diff.installChanges) {
      const cls = c.change >= 0 ? "change-positive" : "change-negative";
      const sign = c.change >= 0 ? "+" : "";
      html += `<div class="diff-item">
        ${esc(c.title)}
        <span class="${cls}">${sign}${formatNumber(c.change)}</span>
        (${formatNumber(c.previousInstalls)} â†’ ${formatNumber(c.currentInstalls)})
      </div>`;
    }
    html += `</div>`;
    return html;
  }

  // â”€â”€ Competition Analyzer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadNicheFinder(signal, autoScoreNiche) {
    showLoading(null);
    try {
      const res = await apiFetch("/api/niches", { signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      $content.innerHTML = renderNicheList(data.niches);
      // Auto-score a specific niche if requested (e.g. from welcome page click)
      if (autoScoreNiche) {
        const safeId = autoScoreNiche.replace(/\s+/g, '_');
        const card = document.getElementById(`niche-card-${safeId}`);
        if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        scoreNiche(autoScoreNiche);
      }
    } catch (err) {
      if (err.name === "AbortError") return;
      showError(err.message);
    }
  }

  function renderNicheList(niches) {
    let html = `<h2 class="section-title">ğŸ” Competition Analyzer</h2>`;
    html += `
      <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius-md);padding:22px 24px;margin-bottom:24px">
        <h3 style="font-size:.95rem;font-weight:600;color:#fff;margin-bottom:12px">How to use the Competition Analyzer</h3>
        <div style="font-size:.84rem;line-height:1.65;color:var(--text-secondary)">
          <p style="margin-bottom:10px">The Competition Analyzer helps you gauge <strong style="color:var(--accent-soft)">how strong the competition is</strong> for any keyword or niche on Google Play â€” so you know where opportunities exist and where the market is already saturated.</p>
          <ol style="padding-left:18px;margin-bottom:12px">
            <li style="margin-bottom:6px"><strong style="color:var(--text)">Click any keyword group</strong> below to compute its <em>Competition Score</em>. The tool will search Google Play for each keyword, analyse the top apps, and rate it from 0â€“100.</li>
            <li style="margin-bottom:6px"><strong style="color:var(--text)">Add custom keywords</strong> using the form below â€” give them a name (e.g. "Pet Care") and at least 2 keywords (e.g. "pet tracker", "dog training app"). Then click to analyze the competition.</li>
            <li style="margin-bottom:6px"><strong style="color:var(--text)">Read the score</strong>: <span style="color:var(--green)">55+ = Weak competition (opportunity!)</span> Â· <span style="color:var(--yellow)">35â€“54 = Moderate</span> Â· <span style="color:var(--red)">&lt; 35 = Strong competition (saturated)</span>.</li>
          </ol>
          <p style="margin-bottom:0"><strong style="color:var(--text)">What gets measured:</strong> Keyword demand (how many apps exist), Saturation (how many have 10M+ installs), Quality gap (apps rated below 4â˜…), Freshness (apps released in the last year), and average installs.</p>
        </div>
      </div>`;

    // Add custom niche form
    html += `
      <div class="niche-add-form" id="nicheAddForm">
        <h3>â• Add Custom Niche</h3>
        <input type="text" id="nicheNameInput" placeholder="Niche name (e.g. Pet Care)" maxlength="50">
        <textarea id="nicheKeywordsInput" placeholder="Keywords, one per line or comma-separated (e.g. pet care app, dog training, cat food...)"></textarea>
        <div class="niche-form-actions">
          <button class="btn-save" onclick="addCustomNiche()">Add Niche</button>
        </div>
        <div id="nicheFormMsg" style="margin-top:8px;font-size:.8rem"></div>
      </div>`;

    html += `<div class="niche-grid">`;
    for (const n of niches) {
      const deleteBtn = !n.builtin
        ? `<button class="btn-delete" onclick="event.stopPropagation();deleteNiche('${esc(n.name)}')">âœ• Remove</button>`
        : '';
      html += `
        <div class="niche-card" id="niche-card-${esc(n.name).replace(/\s+/g, '_')}" onclick="scoreNiche('${esc(n.name)}')">
          ${deleteBtn}
          <div class="niche-name">${esc(n.name)}</div>
          <div style="font-size:.8rem;color:#9ca3af">${n.keywordCount} keywords${n.builtin ? '' : ' Â· custom'}</div>
          <div class="niche-score-area" id="niche-score-${esc(n.name).replace(/\s+/g, '_')}">
            <span style="font-size:.75rem;color:#6b7280">Click to score â†’</span>
          </div>
        </div>`;
    }
    html += `</div>`;
    return html;
  }

  async function addCustomNiche() {
    const nameInput = document.getElementById("nicheNameInput");
    const kwInput = document.getElementById("nicheKeywordsInput");
    const msgEl = document.getElementById("nicheFormMsg");
    const name = nameInput.value.trim();
    const rawKw = kwInput.value.trim();

    if (!name) { msgEl.innerHTML = `<span style="color:#f87171">Enter a niche name</span>`; return; }
    if (!rawKw) { msgEl.innerHTML = `<span style="color:#f87171">Enter at least 2 keywords</span>`; return; }

    // Parse keywords: split by newline or comma
    const keywords = rawKw.split(/[\n,]+/).map(k => k.trim()).filter(k => k.length > 0);
    if (keywords.length < 2) { msgEl.innerHTML = `<span style="color:#f87171">Need at least 2 keywords</span>`; return; }

    msgEl.innerHTML = `<span style="color:#fbbf24">Savingâ€¦</span>`;
    try {
      const res = await apiFetch("/api/niche/custom", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, keywords }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
      msgEl.innerHTML = `<span style="color:#34d399">âœ“ ${data.message}</span>`;
      nameInput.value = "";
      kwInput.value = "";
      // Reload the niche list
      setTimeout(() => _launchEndpoint("niche-finder"), 800);
    } catch (err) {
      msgEl.innerHTML = `<span style="color:#f87171">âš  ${esc(err.message)}</span>`;
    }
  }

  async function deleteNiche(name) {
    if (!confirm(`Delete custom niche "${name}"?`)) return;
    try {
      const res = await apiFetch(`/api/niche/custom/${encodeURIComponent(name)}`, { method: "DELETE" });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
      // Reload
      _launchEndpoint("niche-finder");
    } catch (err) {
      alert("Failed to delete: " + err.message);
    }
  }

  // â”€â”€ Custom Category management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function _rebuildCategoryTabs() {
    // Remove all existing category tabs (and the + button)
    $tabs.querySelectorAll(".tab-btn.dyn-cat, .tab-btn.add-cat-btn").forEach(b => b.remove());
    for (const cat of _categories) {
      const btn = document.createElement("button");
      btn.className = "tab-btn dyn-cat" + (_customCategoryMap[cat] !== undefined ? " custom-cat" : "");
      btn.dataset.endpoint = `/api/category/${cat}`;
      const icon = _customCategoryMap[cat] || CATEGORY_ICONS[cat] || "";
      btn.textContent = (icon ? icon + " " : "") + cat;
      // Add delete button for custom categories
      if (_customCategoryMap[cat] !== undefined) {
        const del = document.createElement("span");
        del.className = "cat-del";
        del.textContent = "âœ•";
        del.onclick = (e) => { e.stopPropagation(); deleteCustomCategory(cat); };
        btn.appendChild(del);
      }
      $tabs.appendChild(btn);
    }
    // Add the "+" button at the end
    const addBtn = document.createElement("button");
    addBtn.className = "tab-btn add-cat-btn";
    addBtn.textContent = "ï¼‹ Add Category";
    addBtn.onclick = () => openAddCatModal();
    $tabs.appendChild(addBtn);
  }

  function openAddCatModal() {
    document.getElementById("addCatOverlay").classList.add("open");
    document.getElementById("catNameInput").focus();
  }
  function closeAddCatModal() {
    document.getElementById("addCatOverlay").classList.remove("open");
    document.getElementById("catFormMsg").innerHTML = "";
  }
  document.getElementById("addCatOverlay").addEventListener("click", (e) => {
    if (e.target === document.getElementById("addCatOverlay")) closeAddCatModal();
  });

  async function addCustomCategory() {
    const nameInput = document.getElementById("catNameInput");
    const emojiInput = document.getElementById("catEmojiInput");
    const qInput = document.getElementById("catQueriesInput");
    const msgEl = document.getElementById("catFormMsg");
    const name = nameInput.value.trim();
    const emoji = emojiInput.value.trim() || "ğŸ“‚";
    const raw = qInput.value.trim();
    if (!name) { msgEl.innerHTML = `<span style="color:#f87171">Enter a category name</span>`; return; }
    const queries = raw.split(/[\n,]+/).map(s => s.trim()).filter(Boolean);
    if (queries.length < 2) { msgEl.innerHTML = `<span style="color:#f87171">Need at least 2 search queries</span>`; return; }

    msgEl.innerHTML = `<span style="color:#fbbf24">Savingâ€¦</span>`;
    try {
      const res = await apiFetch("/api/category/custom", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, queries, emoji }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
      msgEl.innerHTML = `<span style="color:#34d399">âœ“ ${data.message}</span>`;
      nameInput.value = "";
      emojiInput.value = "";
      qInput.value = "";
      // Reload categories and rebuild tabs
      await _reloadCategories();
      closeAddCatModal();
      _renderWelcome();
    } catch (err) {
      msgEl.innerHTML = `<span style="color:#f87171">âš  ${esc(err.message)}</span>`;
    }
  }

  async function deleteCustomCategory(name) {
    if (!confirm(`Delete custom category "${name}"?`)) return;
    try {
      const res = await apiFetch(`/api/category/custom/${encodeURIComponent(name)}`, { method: "DELETE" });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
      await _reloadCategories();
      // If the deleted category was active, go home
      const activeBtn = $tabs.querySelector(".tab-btn.active");
      if (activeBtn && activeBtn.dataset.endpoint === `/api/category/${name}`) {
        _launchEndpoint("welcome");
      }
    } catch (err) {
      alert("Failed to delete: " + err.message);
    }
  }

  async function _reloadCategories() {
    try {
      const res = await fetch("/api/categories");
      const { categories, customCategories } = await res.json();
      _categories = categories;
      _customCategoryMap = customCategories || {};
      _rebuildCategoryTabs();
    } catch (_) {}
  }

  async function scoreNiche(name) {
    const safeId = name.replace(/\s+/g, '_');
    const scoreArea = document.getElementById(`niche-score-${safeId}`);
    if (!scoreArea) return;
    scoreArea.innerHTML = `<div class="spinner" style="width:18px;height:18px;border-width:2px;margin:4px auto"></div>
      <span style="font-size:.75rem;color:#fbbf24">Computing scoreâ€¦ this may take a few minutes</span>`;

    try {
      const res = await apiFetch(`/api/niche/${encodeURIComponent(name)}/score`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const s = await res.json();
      if (s.error) throw new Error(s.error);

      const oppClass = s.opportunityScore >= 55 ? "opp-high" : s.opportunityScore >= 35 ? "opp-medium" : "opp-low";
      const barColor = s.opportunityScore >= 55 ? "#34d399" : s.opportunityScore >= 35 ? "#fbbf24" : "#f87171";
      scoreArea.innerHTML = `
        <span class="opportunity-badge ${oppClass}">${s.opportunityScore}/100</span>
        <div class="score-bar"><div class="score-bar-fill" style="width:${s.opportunityScore}%;background:${barColor}"></div></div>
        <div class="niche-metrics">
          <div class="niche-metric">Keywords: <strong>${s.keywordCount}</strong></div>
          <div class="niche-metric">Avg Results: <strong>${s.avgResultsPerKeyword}</strong></div>
          <div class="niche-metric">Saturation: <strong>${s.saturationPct}%</strong></div>
          <div class="niche-metric">Gap (< 4â˜…): <strong>${s.gapPct}%</strong></div>
          <div class="niche-metric">Fresh Apps: <strong>${s.freshnessPct}%</strong></div>
          <div class="niche-metric">Avg Installs: <strong>${formatNumber(s.avgInstalls)}</strong></div>
        </div>`;
      // Also make clicking open keywords
      const card = document.getElementById(`niche-card-${safeId}`);
      if (card) card.onclick = () => openNicheDetail(name);
    } catch (err) {
      scoreArea.innerHTML = `<span style="font-size:.75rem;color:#f87171">âš  ${esc(err.message)}</span>`;
    }
  }

  async function openNicheDetail(niche) {
    $modalContent.innerHTML = `
      <div class="loading" style="padding:40px 0">
        <div class="spinner"></div>
        Loading ${esc(niche)} keywordsâ€¦
      </div>`;
    $modal.classList.add("open");

    try {
      const res = await apiFetch(`/api/niche/${encodeURIComponent(niche)}/keywords`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      $modalContent.innerHTML = renderKeywords(data.title, data.keywords);
    } catch (err) {
      $modalContent.innerHTML = `<div class="error">âš ï¸ ${esc(err.message)}</div>`;
    }
  }

  // â”€â”€ Insights Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function computeInsights(apps) {
    if (!apps || !apps.length) return null;
    const total = apps.length;
    const scored = apps.filter(a => a.score > 0);
    const avgRating = scored.length ? (scored.reduce((s,a)=>s+a.score,0)/scored.length) : 0;
    const below4 = scored.filter(a => a.score < 4).length;
    const pctBelow4 = scored.length ? Math.round(below4/scored.length*100) : 0;

    // Install distribution
    const brackets = [
      {label:'1B+', min:1e9}, {label:'100M+', min:1e8}, {label:'10M+', min:1e7},
      {label:'1M+', min:1e6}, {label:'100K+', min:1e5}, {label:'<100K', min:0}
    ];
    const installDist = brackets.map(b => ({
      label: b.label,
      count: apps.filter(a => {
        const v = a.realInstalls||0;
        if (b.min === 0) return v < 1e5;
        const nextIdx = brackets.findIndex(x=>x===b)-1;
        const max = nextIdx >= 0 ? brackets[nextIdx].min : Infinity;
        return v >= b.min && v < max;
      }).length
    }));

    // Developer concentration
    const devCounts = {};
    apps.forEach(a => { devCounts[a.developer] = (devCounts[a.developer]||0)+1; });
    const devEntries = Object.entries(devCounts).sort((a,b)=>b[1]-a[1]);
    const topDevs = devEntries.slice(0,5).map(([name,count])=>({name,count}));
    const uniqueDevs = devEntries.length;

    // Free vs paid
    const freeCount = apps.filter(a=>a.free).length;
    const paidCount = total - freeCount;

    // Genre distribution
    const genreCounts = {};
    apps.forEach(a => { if(a.genre) genreCounts[a.genre]=(genreCounts[a.genre]||0)+1; });
    const topGenres = Object.entries(genreCounts).sort((a,b)=>b[1]-a[1]).slice(0,6).map(([name,count])=>({name,count}));

    // Quality gap: low-rated apps with high installs = opportunity
    const qualityGaps = apps.filter(a => a.score > 0 && a.score < 3.5 && (a.realInstalls||0) > 100000)
      .sort((a,b)=>(b.realInstalls||0)-(a.realInstalls||0)).slice(0,5);

    // Revenue estimate (rough): paid apps price * installs * 0.7 (Google cut)
    const revenueApps = apps.filter(a => !a.free && a.price > 0).map(a => ({
      ...a, estRevenue: Math.round(a.price * (a.realInstalls||0) * 0.7)
    })).sort((a,b)=>b.estRevenue-a.estRevenue).slice(0,5);

    // Keyword extraction from titles
    const stopWords = new Set(['the','a','an','and','or','for','of','to','in','on','by','with','is','it','my','&','-','â€“','â€”','app','free','pro','lite','premium']);
    const wordCounts = {};
    apps.forEach(a => {
      const words = a.title.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(w=>w.length>2 && !stopWords.has(w));
      words.forEach(w => { wordCounts[w]=(wordCounts[w]||0)+1; });
    });
    const topKeywords = Object.entries(wordCounts).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([word,count])=>({word,count}));

    return { total, avgRating, pctBelow4, installDist, topDevs, uniqueDevs, freeCount, paidCount, topGenres, qualityGaps, revenueApps, topKeywords };
  }

  function renderInsightsPanel(apps) {
    const existing = document.querySelector('.insights-panel');
    if (existing) existing.remove();
    const ins = computeInsights(apps);
    if (!ins) return;

    const maxInstall = Math.max(...ins.installDist.map(d=>d.count),1);
    const maxGenre = Math.max(...ins.topGenres.map(d=>d.count),1);

    let html = `<div class="insights-panel">
      <h3 style="margin:0 0 12px">ğŸ“Š Market Insights</h3>
      <div class="insight-stats">
        <div class="insight-stat"><span class="insight-stat-value">${ins.total}</span><span class="insight-stat-label">Apps</span></div>
        <div class="insight-stat"><span class="insight-stat-value">${ins.avgRating.toFixed(1)}</span><span class="insight-stat-label">Avg Rating</span></div>
        <div class="insight-stat"><span class="insight-stat-value">${ins.pctBelow4}%</span><span class="insight-stat-label">Below 4â˜…</span></div>
        <div class="insight-stat"><span class="insight-stat-value">${ins.uniqueDevs}</span><span class="insight-stat-label">Developers</span></div>
        <div class="insight-stat"><span class="insight-stat-value">${ins.freeCount}</span><span class="insight-stat-label">Free</span></div>
        <div class="insight-stat"><span class="insight-stat-value">${ins.paidCount}</span><span class="insight-stat-label">Paid</span></div>
      </div>
      <div class="insight-detail-grid">
        <div class="insight-detail-box">
          <h4>ğŸ“¥ Install Distribution</h4>
          ${ins.installDist.map(d=>`<div class="insight-bar-row"><span class="insight-bar-label">${d.label}</span><div class="insight-bar-track"><div class="insight-bar-fill" style="width:${Math.round(d.count/maxInstall*100)}%"></div></div><span class="insight-bar-value">${d.count}</span></div>`).join('')}
        </div>
        <div class="insight-detail-box">
          <h4>ğŸ·ï¸ Top Genres</h4>
          ${ins.topGenres.map(d=>`<div class="insight-bar-row"><span class="insight-bar-label">${esc(d.name)}</span><div class="insight-bar-track"><div class="insight-bar-fill" style="width:${Math.round(d.count/maxGenre*100)}%"></div></div><span class="insight-bar-value">${d.count}</span></div>`).join('')}
        </div>
        <div class="insight-detail-box">
          <h4>ğŸ‘¨â€ğŸ’» Top Developers</h4>
          ${ins.topDevs.map(d=>`<div class="insight-bar-row"><span class="insight-bar-label" title="${esc(d.name)}">${esc(d.name.length>20?d.name.slice(0,20)+'â€¦':d.name)}</span><div class="insight-bar-track"><div class="insight-bar-fill" style="width:${Math.round(d.count/ins.topDevs[0].count*100)}%"></div></div><span class="insight-bar-value">${d.count}</span></div>`).join('')}
        </div>
        <div class="insight-detail-box">
          <h4>ğŸ”‘ Title Keywords</h4>
          ${ins.topKeywords.map(d=>`<div class="insight-bar-row"><span class="insight-bar-label">${esc(d.word)}</span><div class="insight-bar-track"><div class="insight-bar-fill" style="width:${Math.round(d.count/ins.topKeywords[0].count*100)}%"></div></div><span class="insight-bar-value">${d.count}</span></div>`).join('')}
        </div>`;

    // Quality gaps
    if (ins.qualityGaps.length) {
      html += `<div class="insight-detail-box" style="grid-column:1/-1">
        <h4>âš ï¸ Quality Gap Opportunities <small style="font-weight:400;color:var(--text-secondary)">(Low-rated apps with high installs)</small></h4>
        <table class="growth-table"><thead><tr><th>App</th><th>Rating</th><th>Installs</th><th>Developer</th></tr></thead><tbody>
        ${ins.qualityGaps.map(a=>`<tr><td>${esc(a.title)}</td><td>â­ ${a.score.toFixed(1)}</td><td>${(a.realInstalls||0).toLocaleString()}</td><td>${esc(a.developer)}</td></tr>`).join('')}
        </tbody></table></div>`;
    }

    // Revenue estimates
    if (ins.revenueApps.length) {
      html += `<div class="insight-detail-box" style="grid-column:1/-1">
        <h4>ğŸ’° Top Revenue Estimates <small style="font-weight:400;color:var(--text-secondary)">(Paid apps only, rough estimate)</small></h4>
        <table class="growth-table"><thead><tr><th>App</th><th>Price</th><th>Installs</th><th>Est. Revenue</th></tr></thead><tbody>
        ${ins.revenueApps.map(a=>`<tr><td>${esc(a.title)}</td><td>$${a.price.toFixed(2)}</td><td>${(a.realInstalls||0).toLocaleString()}</td><td>$${a.estRevenue.toLocaleString()}</td></tr>`).join('')}
        </tbody></table></div>`;
    }

    html += `</div>`;

    // Add clusters
    html += renderClusters(apps);

    html += `</div>`;

    const $content = document.getElementById("mainContent");
    const grid = $content.querySelector('#appGrid');
    if (grid) grid.insertAdjacentHTML('beforebegin', html);
  }

  // â”€â”€ Filter Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderFilterBar(apps) {
    const existing = document.querySelector('.filter-bar');
    if (existing) existing.remove();
    if (!apps || !apps.length) return;

    const html = `<div class="filter-bar">
      <input type="text" id="filterSearch" class="filter-control" placeholder="ğŸ” Search apps..." style="flex:2">
      <select id="filterRating" class="filter-control">
        <option value="">All Ratings</option>
        <option value="4.5">4.5+ â˜…</option>
        <option value="4">4+ â˜…</option>
        <option value="3">3+ â˜…</option>
        <option value="0-3">Below 3 â˜…</option>
      </select>
      <select id="filterInstalls" class="filter-control">
        <option value="">All Installs</option>
        <option value="1e9">1B+</option>
        <option value="1e8">100M+</option>
        <option value="1e7">10M+</option>
        <option value="1e6">1M+</option>
        <option value="1e5">100K+</option>
        <option value="0-1e5">Under 100K</option>
      </select>
      <select id="filterType" class="filter-control">
        <option value="">Free & Paid</option>
        <option value="free">Free Only</option>
        <option value="paid">Paid Only</option>
      </select>
      <button id="filterReset" class="filter-control" style="background:var(--accent);color:#fff;cursor:pointer;border:none;padding:6px 12px;border-radius:8px">Reset</button>
    </div>`;

    const $content = document.getElementById("mainContent");
    const panel = $content.querySelector('.insights-panel');
    const grid = $content.querySelector('#appGrid');
    if (panel) panel.insertAdjacentHTML('afterend', html);
    else if (grid) grid.insertAdjacentHTML('beforebegin', html);
  }

  function _attachFilterListeners() {
    const search = document.getElementById('filterSearch');
    const rating = document.getElementById('filterRating');
    const installs = document.getElementById('filterInstalls');
    const type = document.getElementById('filterType');
    const reset = document.getElementById('filterReset');
    if (!search) return;

    const applyFilters = () => {
      const q = search.value.toLowerCase();
      const rVal = rating.value;
      const iVal = installs.value;
      const tVal = type.value;

      let filtered = _currentApps.filter(app => {
        // Search
        if (q && !app.title.toLowerCase().includes(q) && !app.developer.toLowerCase().includes(q)) return false;
        // Rating
        if (rVal === '0-3' && (app.score||0) >= 3) return false;
        if (rVal && rVal !== '0-3' && (app.score||0) < parseFloat(rVal)) return false;
        // Installs
        if (iVal && iVal.startsWith('0-')) {
          if ((app.realInstalls||0) >= parseFloat(iVal.split('-')[1])) return false;
        } else if (iVal && (app.realInstalls||0) < parseFloat(iVal)) return false;
        // Type
        if (tVal === 'free' && !app.free) return false;
        if (tVal === 'paid' && app.free) return false;
        return true;
      });

      // Re-rank
      filtered = filtered.map((a,i)=>({...a, rank:i+1}));

      const grid = document.getElementById('appGrid');
      if (!grid) return;
      grid.innerHTML = '';
      for (const app of filtered) {
        const topClass = app.rank <= 3 ? "top3" : "";
        const stars = app.score ? "â­ " + app.score.toFixed(1) : "";
        const isBookmarked = _bookmarkedIds.has(app.appId);
        grid.innerHTML += `
          <div class="card-link" data-appid="${esc(app.appId)}" style="cursor:pointer" data-rank="${app.rank}" data-score="${app.score||0}" data-installs="${app.realInstalls||0}" data-free="${app.free?1:0}" data-dev="${esc(app.developer)}">
            <div class="card">
              <button class="bookmark-star${isBookmarked?' bookmarked':''}" data-appid="${esc(app.appId)}" onclick="event.stopPropagation();toggleBookmark('${esc(app.appId)}')" title="Bookmark">${isBookmarked?'â˜…':'â˜†'}</button>
              <span class="rank ${topClass}">#${app.rank}</span>
              <img class="icon" src="${app.icon}" alt="" loading="lazy" />
              <div class="info">
                <div class="name" title="${esc(app.title)}">${esc(app.title)}</div>
                <div class="dev">${esc(app.developer)}</div>
              </div>
              <div class="meta">
                <div class="installs">${app.installs}</div>
                <div class="rating">${stars}</div>
                <div class="genre">${esc(app.genre)}</div>
              </div>
            </div>
          </div>`;
      }
      // Update count in title
      const titleEl = document.querySelector('.section-title');
      if (titleEl) titleEl.textContent = `${_currentTitle} (${filtered.length} apps)`;
      // Re-attach card clicks & lazy load
      _attachCardClicks();
      loadImagesStaggered(document.getElementById('appGrid'));
      _loadBookmarkStars(filtered);
    };

    search.addEventListener('input', applyFilters);
    rating.addEventListener('change', applyFilters);
    installs.addEventListener('change', applyFilters);
    type.addEventListener('change', applyFilters);
    reset.addEventListener('click', () => {
      search.value = ''; rating.value = ''; installs.value = ''; type.value = '';
      applyFilters();
    });
  }

  // â”€â”€ Bookmarks & Notes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function _loadBookmarkStars(apps) {
    try {
      const res = await apiFetch('/api/bookmarks');
      if (!res.ok) return;
      const data = await res.json();
      _bookmarkedIds = new Set((data.bookmarks||[]).map(b=>b.app_id));
    } catch(e) { /* ignore */ }

    document.querySelectorAll('.bookmark-star').forEach(btn => {
      const id = btn.dataset.appid;
      if (_bookmarkedIds.has(id)) {
        btn.classList.add('bookmarked');
        btn.textContent = 'â˜…';
      }
    });
  }

  window.toggleBookmark = async function(appId) {
    const isBookmarked = _bookmarkedIds.has(appId);
    try {
      if (isBookmarked) {
        await apiFetch(`/api/notes/${encodeURIComponent(appId)}`, {method:'DELETE'});
        _bookmarkedIds.delete(appId);
      } else {
        await apiFetch(`/api/notes/${encodeURIComponent(appId)}`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({note_text:'', bookmarked:1})
        });
        _bookmarkedIds.add(appId);
      }
    } catch(e) { /* ignore */ }

    document.querySelectorAll(`.bookmark-star[data-appid="${appId}"]`).forEach(btn => {
      const now = _bookmarkedIds.has(appId);
      btn.classList.toggle('bookmarked', now);
      btn.textContent = now ? 'â˜…' : 'â˜†';
    });
  };

  // â”€â”€ App Clustering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function clusterApps(apps) {
    const stopWords = new Set(['the','a','an','and','or','for','of','to','in','on','by','with','is','it','my','&','-','â€“','â€”','app','free','pro','lite','premium','best','new','top']);
    // Extract significant words per app
    const appWords = apps.map(a => {
      const words = a.title.toLowerCase().replace(/[^a-z0-9\s]/g,' ').split(/\s+/).filter(w=>w.length>2 && !stopWords.has(w));
      return { app: a, words: new Set(words) };
    });

    // Find clusters around common keywords
    const wordApps = {};
    appWords.forEach(({app, words}) => {
      words.forEach(w => {
        if (!wordApps[w]) wordApps[w] = [];
        wordApps[w].push(app);
      });
    });

    // Only keep words that appear in 3+ apps
    const clusters = Object.entries(wordApps)
      .filter(([w,apps])=>apps.length>=3)
      .sort((a,b)=>b[1].length-a[1].length)
      .slice(0,8)
      .map(([word,apps])=>({keyword:word, apps:apps.slice(0,10), count:apps.length}));

    return clusters;
  }

  function renderClusters(apps) {
    const clusters = clusterApps(apps);
    if (!clusters.length) return '';

    let html = `<div class="cluster-section"><h3>ğŸ”— App Clusters by Keyword</h3>`;
    clusters.forEach(c => {
      html += `<div class="cluster-group"><div class="cluster-label">"${esc(c.keyword)}" <span style="color:var(--text-secondary)">(${c.count} apps)</span></div>`;
      html += `<div class="cluster-apps">`;
      c.apps.forEach(a => {
        html += `<div class="cluster-app" title="${esc(a.title)}"><img src="${a.icon}" class="cluster-icon" loading="lazy"/><span>${esc(a.title.length>25?a.title.slice(0,25)+'â€¦':a.title)}</span></div>`;
      });
      html += `</div></div>`;
    });
    html += `</div>`;
    return html;
  }

  // â”€â”€ Category Comparison â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadCategoryComparison() {
    const $content = document.getElementById("mainContent");
    $content.innerHTML = `<h2 class="section-title">ğŸ“Š Category Comparison</h2>
      <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:end">
        <div><label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:4px">Category A</label>
          <select id="compareA" class="filter-control" style="min-width:200px"></select></div>
        <div><label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:4px">Category B</label>
          <select id="compareB" class="filter-control" style="min-width:200px"></select></div>
        <button onclick="runComparison()" style="background:var(--accent);color:#fff;border:none;padding:8px 18px;border-radius:8px;cursor:pointer;font-weight:600">Compare</button>
      </div>
      <div id="comparisonResult"></div>`;

    // Populate dropdowns
    const cats = _categories.length ? _categories : await fetchCategories();
    const selA = document.getElementById('compareA');
    const selB = document.getElementById('compareB');
    cats.forEach((c,i) => {
      selA.innerHTML += `<option value="${esc(c.key)}">${c.emoji} ${esc(c.name)}</option>`;
      selB.innerHTML += `<option value="${esc(c.key)}" ${i===1?'selected':''}>${c.emoji} ${esc(c.name)}</option>`;
    });
  }

  async function fetchCategories() {
    try {
      const res = await apiFetch('/api/categories');
      if (res.ok) { const d = await res.json(); _categories = d.categories; return _categories; }
    } catch(e) {}
    return [];
  }

  window.runComparison = async function() {
    const keyA = document.getElementById('compareA').value;
    const keyB = document.getElementById('compareB').value;
    const $result = document.getElementById('comparisonResult');
    $result.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>Loading categories...</p></div>';

    try {
      const [resA, resB] = await Promise.all([
        apiFetch(`/api/top?key=${encodeURIComponent(keyA)}`).then(r=>r.json()),
        apiFetch(`/api/top?key=${encodeURIComponent(keyB)}`).then(r=>r.json())
      ]);

      const insA = computeInsights(resA.apps);
      const insB = computeInsights(resB.apps);
      if (!insA || !insB) { $result.innerHTML = '<div class="error">No data available</div>'; return; }

      const labelA = _categories.find(c=>c.key===keyA)?.name || keyA;
      const labelB = _categories.find(c=>c.key===keyB)?.name || keyB;

      const rows = [
        ['Total Apps', insA.total, insB.total],
        ['Avg Rating', insA.avgRating.toFixed(2), insB.avgRating.toFixed(2)],
        ['Below 4â˜…', insA.pctBelow4+'%', insB.pctBelow4+'%'],
        ['Unique Devs', insA.uniqueDevs, insB.uniqueDevs],
        ['Free Apps', insA.freeCount, insB.freeCount],
        ['Paid Apps', insA.paidCount, insB.paidCount],
        ['Top Genre', insA.topGenres[0]?.name||'-', insB.topGenres[0]?.name||'-'],
        ['Top Dev', insA.topDevs[0]?.name||'-', insB.topDevs[0]?.name||'-'],
      ];

      $result.innerHTML = `<div class="cat-compare-grid">
        <table class="growth-table"><thead><tr><th>Metric</th><th>${esc(labelA)}</th><th>${esc(labelB)}</th></tr></thead>
        <tbody>${rows.map(r=>`<tr><td style="font-weight:500">${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>`).join('')}</tbody></table>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
        <div>
          <h4 style="margin:0 0 8px">${esc(labelA)} â€” Top Keywords</h4>
          <div style="display:flex;flex-wrap:wrap;gap:6px">${insA.topKeywords.map(k=>`<span style="background:var(--card-bg);padding:4px 10px;border-radius:12px;font-size:13px">${esc(k.word)} <small style="color:var(--text-secondary)">(${k.count})</small></span>`).join('')}</div>
        </div>
        <div>
          <h4 style="margin:0 0 8px">${esc(labelB)} â€” Top Keywords</h4>
          <div style="display:flex;flex-wrap:wrap;gap:6px">${insB.topKeywords.map(k=>`<span style="background:var(--card-bg);padding:4px 10px;border-radius:12px;font-size:13px">${esc(k.word)} <small style="color:var(--text-secondary)">(${k.count})</small></span>`).join('')}</div>
        </div>
      </div>
      ${renderClusters(resA.apps)}
      ${renderClusters(resB.apps)}`;
    } catch(err) {
      $result.innerHTML = `<div class="error">âš ï¸ ${esc(err.message)}</div>`;
    }
  };

  // â”€â”€ Growth Velocity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadGrowthData() {
    try {
      const res = await apiFetch('/api/growth');
      if (!res.ok) return null;
      return await res.json();
    } catch(e) { return null; }
  }

  function renderGrowthSection(data) {
    if (!data || !data.growth || !data.growth.length) {
      return `<div class="insight-detail-box" style="grid-column:1/-1"><h4>ğŸ“ˆ Growth Velocity</h4><p style="color:var(--text-secondary)">No snapshot data yet. Run the scheduler to collect data over time.</p></div>`;
    }

    let html = `<div class="insight-detail-box" style="grid-column:1/-1">
      <h4>ğŸ“ˆ Growth Velocity <small style="font-weight:400;color:var(--text-secondary)">(Based on snapshot comparisons)</small></h4>
      <table class="growth-table"><thead><tr><th>#</th><th>App</th><th>Installs</th><th>Growth</th><th>Score</th><th>Status</th></tr></thead><tbody>`;

    data.growth.slice(0,30).forEach((g,i) => {
      const badge = g.isNew ? '<span style="background:#22c55e;color:#fff;padding:2px 8px;border-radius:8px;font-size:11px">NEW</span>' :
        `<span style="color:#22c55e;font-weight:600">+${(g.growth||0).toLocaleString()}</span>`;
      html += `<tr>
        <td>${i+1}</td>
        <td style="font-weight:500">${esc(g.title||g.appId)}</td>
        <td>${(g.installs||0).toLocaleString()}</td>
        <td>${badge}</td>
        <td>${g.score?'â­ '+g.score.toFixed(1):'-'}</td>
        <td>${g.isNew?'New Entry':'Growing'}</td>
      </tr>`;
    });

    html += `</tbody></table></div>`;
    return html;
  }

  // â”€â”€ Notes UI in Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function renderNoteSection(appId) {
    let note = null;
    try {
      const res = await apiFetch(`/api/notes/${encodeURIComponent(appId)}`);
      if (res.ok) { const d = await res.json(); note = d.note; }
    } catch(e) {}

    const noteText = note ? note.note_text : '';
    const isBookmarked = note ? note.bookmarked : (_bookmarkedIds.has(appId)?1:0);

    return `<div class="note-section">
      <h4 style="margin:0 0 8px;display:flex;align-items:center;gap:8px">
        ğŸ“ Notes
        <button class="bookmark-star${isBookmarked?' bookmarked':''}" onclick="toggleDetailBookmark('${esc(appId)}')" id="detailBookmark" style="position:static;font-size:18px">${isBookmarked?'â˜…':'â˜†'}</button>
      </h4>
      <textarea id="noteTextarea" placeholder="Add your research notes..." style="width:100%;min-height:80px;background:var(--bg-color);color:var(--text-primary);border:1px solid var(--border-color);border-radius:8px;padding:10px;font-family:inherit;font-size:14px;resize:vertical">${esc(noteText)}</textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button onclick="saveNote('${esc(appId)}')" style="background:var(--accent);color:#fff;border:none;padding:6px 16px;border-radius:8px;cursor:pointer;font-weight:600">Save Note</button>
        ${note ? `<button onclick="deleteNote('${esc(appId)}')" style="background:var(--error);color:#fff;border:none;padding:6px 16px;border-radius:8px;cursor:pointer">Delete</button>` : ''}
      </div>
    </div>`;
  }

  window.saveNote = async function(appId) {
    const text = document.getElementById('noteTextarea')?.value || '';
    const bm = document.getElementById('detailBookmark')?.classList.contains('bookmarked') ? 1 : 0;
    try {
      await apiFetch(`/api/notes/${encodeURIComponent(appId)}`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({note_text:text, bookmarked:bm})
      });
      if (bm) _bookmarkedIds.add(appId); else _bookmarkedIds.delete(appId);
      showToast('Note saved âœ“');
    } catch(e) { showToast('Failed to save note'); }
  };

  window.deleteNote = async function(appId) {
    try {
      await apiFetch(`/api/notes/${encodeURIComponent(appId)}`, {method:'DELETE'});
      _bookmarkedIds.delete(appId);
      document.getElementById('noteTextarea').value = '';
      showToast('Note deleted');
    } catch(e) { showToast('Failed to delete note'); }
  };

  window.toggleDetailBookmark = function(appId) {
    const btn = document.getElementById('detailBookmark');
    if (!btn) return;
    btn.classList.toggle('bookmarked');
    const now = btn.classList.contains('bookmarked');
    btn.textContent = now ? 'â˜…' : 'â˜†';
  };

  function showToast(msg) {
    const existing = document.querySelector('.toast-msg');
    if (existing) existing.remove();
    const t = document.createElement('div');
    t.className = 'toast-msg';
    t.textContent = msg;
    t.style.cssText = 'position:fixed;bottom:24px;right:24px;background:var(--card-bg);color:var(--text-primary);padding:12px 20px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:10001;font-size:14px;animation:fadeIn .2s';
    document.body.appendChild(t);
    setTimeout(()=>t.remove(), 2500);
  }

  // Re-attach card clicks after filter changes
  function _attachCardClicks() {
    document.querySelectorAll('.card-link').forEach(el => {
      el.onclick = () => openAppDetail(el.dataset.appid);
    });
  }

  // â”€â”€ Analysis & Comparison â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let _cachedAllApps = [];  // cache for dropdown population

  async function loadAnalysis(signal) {
    const eta = await _fetchEta("top");
    showLoading(eta);
    // Load the general top apps for the dropdowns (from DB if cached)
    try {
      const res = await apiFetch("/api/top", { signal });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      _cachedAllApps = data.apps || [];
    } catch (err) {
      if (err.name === "AbortError") return;
      _cachedAllApps = [];
    }

    let optionsHtml = '<option value="">Select an appâ€¦</option>';
    for (const a of _cachedAllApps) {
      optionsHtml += `<option value="${esc(a.appId)}">${esc(a.title)}</option>`;
    }

    $content.innerHTML = `
      <h2 class="section-title">ğŸ“Š App Analysis & Comparison</h2>

      <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap">
        <button class="toolbar-btn" onclick="showAnalysisSection('compare')" id="analysisTabCompare" style="background:var(--accent);color:#fff">ğŸ” App Comparison</button>
        <button class="toolbar-btn" onclick="showAnalysisSection('growth')" id="analysisTabGrowth">ğŸ“ˆ Growth Velocity</button>
        <button class="toolbar-btn" onclick="showAnalysisSection('catcompare')" id="analysisTabCatCompare">ğŸ“Š Category Comparison</button>
        <button class="toolbar-btn" onclick="showAnalysisSection('bookmarks')" id="analysisTabBookmarks">â­ Bookmarks</button>
      </div>

      <div id="analysisSectionCompare" class="analysis-panel">
        <p style="font-size:.85rem;color:#9ca3af;margin-bottom:16px">
          Select two apps to compare their descriptions (word overlap) and view install growth from snapshots.
          You can also paste a package ID directly.
        </p>
        <div class="compare-form">
          <label>App 1
            <select id="cmpSel1" onchange="document.getElementById('cmpId1').value=this.value">
              ${optionsHtml}
            </select>
          </label>
          <label>or Package ID
            <input id="cmpId1" placeholder="com.example.app1" />
          </label>
          <label>App 2
            <select id="cmpSel2" onchange="document.getElementById('cmpId2').value=this.value">
              ${optionsHtml}
            </select>
          </label>
          <label>or Package ID
            <input id="cmpId2" placeholder="com.example.app2" />
          </label>
          <button class="compare-btn" onclick="runAppComparison()">Compare</button>
        </div>
        <div id="compareResults"></div>
      </div>

      <div id="analysisSectionGrowth" class="analysis-panel" style="display:none">
        <div id="growthContent"><div class="loading"><div class="spinner"></div> Loading growth data...</div></div>
      </div>

      <div id="analysisSectionCatCompare" class="analysis-panel" style="display:none">
        <div id="catCompareContent"></div>
      </div>

      <div id="analysisSectionBookmarks" class="analysis-panel" style="display:none">
        <div id="bookmarksContent"><div class="loading"><div class="spinner"></div> Loading bookmarks...</div></div>
      </div>
    `;

    // Preload growth data
    loadGrowthData().then(data => {
      const el = document.getElementById('growthContent');
      if (el) el.innerHTML = renderGrowthSection(data);
    });

    // Preload bookmarks
    loadBookmarksView();
  }

  window.showAnalysisSection = function(which) {
    ['compare','growth','catcompare','bookmarks'].forEach(s => {
      const el = document.getElementById('analysisSection' + s.charAt(0).toUpperCase() + s.slice(1));
      const tab = document.getElementById('analysisTab' + s.charAt(0).toUpperCase() + s.slice(1));
      if (el) el.style.display = s===which ? '' : 'none';
      if (tab) { tab.style.background = s===which ? 'var(--accent)' : ''; tab.style.color = s===which ? '#fff' : ''; }
    });

    // Load category comparison on demand
    if (which === 'catcompare') {
      const el = document.getElementById('catCompareContent');
      if (el && !el.dataset.loaded) {
        el.dataset.loaded = '1';
        renderCatCompareInline(el);
      }
    }
  };

  async function renderCatCompareInline(container) {
    const cats = _categories.length ? _categories : await fetchCategories();
    let catOpts = cats.map((c,i) => `<option value="${esc(c.key)}" ${i===0?'selected':''}>${c.emoji} ${esc(c.name)}</option>`).join('');

    container.innerHTML = `
      <p style="font-size:.85rem;color:#9ca3af;margin-bottom:16px">Compare stats between two categories side by side.</p>
      <div style="display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;align-items:end">
        <div><label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:4px">Category A</label>
          <select id="inlineCmpA" class="filter-control" style="min-width:200px">${catOpts}</select></div>
        <div><label style="display:block;font-size:12px;color:var(--text-secondary);margin-bottom:4px">Category B</label>
          <select id="inlineCmpB" class="filter-control" style="min-width:200px">${catOpts.replace('selected','').replace(cats.length>1?`value="${esc(cats[1].key)}"`:'value=""', `value="${esc(cats.length>1?cats[1].key:cats[0].key)}" selected`)}</select></div>
        <button onclick="runInlineCatCompare()" style="background:var(--accent);color:#fff;border:none;padding:8px 18px;border-radius:8px;cursor:pointer;font-weight:600">Compare</button>
      </div>
      <div id="inlineCmpResult"></div>`;
  }

  window.runInlineCatCompare = async function() {
    const keyA = document.getElementById('inlineCmpA').value;
    const keyB = document.getElementById('inlineCmpB').value;
    const $result = document.getElementById('inlineCmpResult');
    $result.innerHTML = '<div class="loading"><div class="spinner"></div> Comparing...</div>';

    try {
      const [resA, resB] = await Promise.all([
        apiFetch(`/api/top?key=${encodeURIComponent(keyA)}`).then(r=>r.json()),
        apiFetch(`/api/top?key=${encodeURIComponent(keyB)}`).then(r=>r.json())
      ]);

      const insA = computeInsights(resA.apps);
      const insB = computeInsights(resB.apps);
      if (!insA || !insB) { $result.innerHTML = '<div class="error">No data available. Fetch both categories first.</div>'; return; }

      const labelA = _categories.find(c=>c.key===keyA)?.name || keyA;
      const labelB = _categories.find(c=>c.key===keyB)?.name || keyB;

      const rows = [
        ['Total Apps', insA.total, insB.total],
        ['Avg Rating', insA.avgRating.toFixed(2), insB.avgRating.toFixed(2)],
        ['Below 4â˜…', insA.pctBelow4+'%', insB.pctBelow4+'%'],
        ['Unique Devs', insA.uniqueDevs, insB.uniqueDevs],
        ['Free Apps', insA.freeCount, insB.freeCount],
        ['Paid Apps', insA.paidCount, insB.paidCount],
        ['Top Genre', insA.topGenres[0]?.name||'-', insB.topGenres[0]?.name||'-'],
        ['Top Dev', insA.topDevs[0]?.name||'-', insB.topDevs[0]?.name||'-'],
      ];

      $result.innerHTML = `<table class="growth-table"><thead><tr><th>Metric</th><th>${esc(labelA)}</th><th>${esc(labelB)}</th></tr></thead>
        <tbody>${rows.map(r=>`<tr><td style="font-weight:500">${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td></tr>`).join('')}</tbody></table>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
          <div><h4 style="margin:0 0 8px">${esc(labelA)} â€” Keywords</h4>
            <div style="display:flex;flex-wrap:wrap;gap:6px">${insA.topKeywords.map(k=>`<span style="background:var(--card-bg);padding:4px 10px;border-radius:12px;font-size:13px">${esc(k.word)} <small style="color:var(--text-secondary)">(${k.count})</small></span>`).join('')}</div></div>
          <div><h4 style="margin:0 0 8px">${esc(labelB)} â€” Keywords</h4>
            <div style="display:flex;flex-wrap:wrap;gap:6px">${insB.topKeywords.map(k=>`<span style="background:var(--card-bg);padding:4px 10px;border-radius:12px;font-size:13px">${esc(k.word)} <small style="color:var(--text-secondary)">(${k.count})</small></span>`).join('')}</div></div>
        </div>`;
    } catch(err) {
      $result.innerHTML = `<div class="error">âš ï¸ ${esc(err.message)}</div>`;
    }
  };

  async function loadBookmarksView() {
    const el = document.getElementById('bookmarksContent');
    if (!el) return;
    try {
      const res = await apiFetch('/api/bookmarks');
      if (!res.ok) throw new Error('Failed to load');
      const data = await res.json();
      const bookmarks = data.bookmarks || [];
      if (!bookmarks.length) {
        el.innerHTML = '<p style="color:var(--text-secondary);padding:20px">No bookmarked apps yet. Click the â˜† star on any app card to bookmark it.</p>';
        return;
      }
      let html = `<h4 style="margin:0 0 12px">â­ Bookmarked Apps (${bookmarks.length})</h4>
        <table class="growth-table"><thead><tr><th>App ID</th><th>Note</th><th>Bookmarked</th><th>Actions</th></tr></thead><tbody>`;
      bookmarks.forEach(b => {
        html += `<tr>
          <td style="cursor:pointer;color:var(--accent)" onclick="openAppDetail('${esc(b.app_id)}')">${esc(b.app_id)}</td>
          <td>${esc((b.note_text||'').slice(0,60))}${(b.note_text||'').length>60?'â€¦':''}</td>
          <td>${b.created_at||'-'}</td>
          <td><button onclick="deleteNote('${esc(b.app_id)}');this.closest('tr').remove()" style="background:var(--error);color:#fff;border:none;padding:4px 10px;border-radius:6px;cursor:pointer;font-size:12px">Remove</button></td>
        </tr>`;
      });
      html += '</tbody></table>';
      el.innerHTML = html;
    } catch(e) {
      el.innerHTML = '<p style="color:var(--text-secondary)">Failed to load bookmarks.</p>';
    }
  }

  let _chartInstance = null;

  window.runAppComparison = async function() {
    const id1 = document.getElementById("cmpId1").value.trim();
    const id2 = document.getElementById("cmpId2").value.trim();
    const $results = document.getElementById("compareResults");
    if (!id1 || !id2) {
      $results.innerHTML = '<div class="error">Please select or enter both apps.</div>';
      return;
    }
    $results.innerHTML = `
      <div class="loading" style="padding:30px 0">
        <div class="spinner"></div>Comparing appsâ€¦
      </div>`;

    try {
      // Fetch comparison + install histories in parallel
      const [cmpRes, hist1Res, hist2Res] = await Promise.all([
        apiFetch(`/api/compare?app1=${encodeURIComponent(id1)}&app2=${encodeURIComponent(id2)}`),
        apiFetch(`/api/install-history/${encodeURIComponent(id1)}`),
        apiFetch(`/api/install-history/${encodeURIComponent(id2)}`),
      ]);

      if (!cmpRes.ok) { const e = await cmpRes.json(); throw new Error(e.error || `HTTP ${cmpRes.status}`); }
      const cmp = await cmpRes.json();
      const hist1 = hist1Res.ok ? await hist1Res.json() : { history: [] };
      const hist2 = hist2Res.ok ? await hist2Res.json() : { history: [] };

      $results.innerHTML = renderComparison(cmp, hist1, hist2);

      // Render chart
      renderInstallChart(cmp, hist1, hist2);
    } catch (err) {
      $results.innerHTML = `<div class="error">âš ï¸ ${esc(err.message)}</div>`;
    }
  }

  function renderComparison(cmp, hist1, hist2) {
    const a1 = cmp.app1;
    const a2 = cmp.app2;

    let html = '';

    // Side-by-side app cards
    html += `<div class="compare-result">`;
    html += renderCompareCard(a1, "#7c3aed");
    html += renderCompareCard(a2, "#34d399");
    html += `</div>`;

    // Overlap
    html += `<span class="overlap-badge">Description Overlap: ${cmp.overlapPct}%</span>`;

    // Shared words
    html += `<div class="word-section"><h3>ğŸ”— Shared Keywords (${cmp.sharedWords.length})</h3><div class="word-chips">`;
    for (const w of cmp.sharedWords) {
      html += `<span class="word-chip shared">${esc(w.word)} (${w.countApp1}/${w.countApp2})</span>`;
    }
    html += `</div></div>`;

    // Only App 1
    html += `<div class="word-section"><h3>ğŸŸ£ Only in ${esc(a1.title)} (${cmp.onlyApp1.length})</h3><div class="word-chips">`;
    for (const w of cmp.onlyApp1) {
      html += `<span class="word-chip only1">${esc(w.word)} (${w.count})</span>`;
    }
    html += `</div></div>`;

    // Only App 2
    html += `<div class="word-section"><h3>ğŸŸ¢ Only in ${esc(a2.title)} (${cmp.onlyApp2.length})</h3><div class="word-chips">`;
    for (const w of cmp.onlyApp2) {
      html += `<span class="word-chip only2">${esc(w.word)} (${w.count})</span>`;
    }
    html += `</div></div>`;

    // Chart placeholder
    html += `
      <div class="chart-container">
        <h3 class="section-title" style="font-size:1rem;margin-bottom:10px">ğŸ“ˆ Install Growth (from snapshots)</h3>
        <canvas id="installChart"></canvas>
        ${(hist1.history.length === 0 && hist2.history.length === 0)
          ? '<p style="font-size:.82rem;color:#6b7280;margin-top:8px">No snapshot history yet. Save snapshots over time to see growth.</p>'
          : ''}
      </div>`;

    return html;
  }

  function renderCompareCard(app, borderColor) {
    const stars = app.score ? "â­ " + app.score.toFixed(1) : "N/A";
    return `
      <div class="compare-app-card" style="border-top:3px solid ${borderColor}">
        <div class="app-hdr">
          <img src="${app.icon}" alt="" />
          <div>
            <div class="app-title">${esc(app.title)}</div>
            <div class="app-dev">${esc(app.developer)}</div>
          </div>
        </div>
        <div class="niche-metrics">
          <div class="niche-metric">Installs: <strong>${app.installs}</strong></div>
          <div class="niche-metric">Rating: <strong>${stars}</strong></div>
          <div class="niche-metric">Ratings: <strong>${formatNumber(app.ratings || 0)}</strong></div>
          <div class="niche-metric">Genre: <strong>${esc(app.genre)}</strong></div>
          <div class="niche-metric">Released: <strong>${esc(app.released || "N/A")}</strong></div>
          <div class="niche-metric">Words: <strong>${app.totalWords} (${app.uniqueWords} unique)</strong></div>
        </div>
      </div>`;
  }

  function renderInstallChart(cmp, hist1, hist2) {
    const canvas = document.getElementById("installChart");
    if (!canvas) return;

    // Destroy previous chart
    if (_chartInstance) { _chartInstance.destroy(); _chartInstance = null; }

    // Merge dates
    const allDates = new Set();
    for (const h of hist1.history) allDates.add(h.date.slice(0, 10));
    for (const h of hist2.history) allDates.add(h.date.slice(0, 10));

    if (allDates.size === 0) {
      // No snapshot data â€” show current installs as a single bar
      _chartInstance = new Chart(canvas.getContext("2d"), {
        type: "bar",
        data: {
          labels: [cmp.app1.title, cmp.app2.title],
          datasets: [{
            label: "Current Installs",
            data: [cmp.app1.realInstalls, cmp.app2.realInstalls],
            backgroundColor: ["#7c3aed", "#34d399"],
            borderRadius: 6,
          }],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            y: { ticks: { color: "#9ca3af" }, grid: { color: "#272a3a" } },
            x: { ticks: { color: "#9ca3af" }, grid: { display: false } },
          },
        },
      });
      return;
    }

    const labels = [...allDates].sort();
    const map1 = {};
    const map2 = {};
    for (const h of hist1.history) map1[h.date.slice(0, 10)] = h.realInstalls;
    for (const h of hist2.history) map2[h.date.slice(0, 10)] = h.realInstalls;

    _chartInstance = new Chart(canvas.getContext("2d"), {
      type: "line",
      data: {
        labels,
        datasets: [
          {
            label: cmp.app1.title,
            data: labels.map(d => map1[d] ?? null),
            borderColor: "#7c3aed",
            backgroundColor: "rgba(124,58,237,.15)",
            fill: true, tension: .3, spanGaps: true,
          },
          {
            label: cmp.app2.title,
            data: labels.map(d => map2[d] ?? null),
            borderColor: "#34d399",
            backgroundColor: "rgba(52,211,153,.15)",
            fill: true, tension: .3, spanGaps: true,
          },
        ],
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { labels: { color: "#e0e0e0" } },
        },
        scales: {
          y: { ticks: { color: "#9ca3af" }, grid: { color: "#272a3a" } },
          x: { ticks: { color: "#9ca3af" }, grid: { color: "#272a3a" } },
        },
      },
    });
  }
</script>

</body>
</html>
